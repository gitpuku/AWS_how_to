Day6 のハンズオンに関する情報を掲載します。

# Day6-2

## 1. Cognito ユーザープールの作成

### 1.1 Cognito サービスへの移動

1. AWS マネジメントコンソール左上の検索窓に「cognito」と入力
2. ハンバーガーメニュー(左上)を押す
3. 「ユーザープール」をクリック

### 1.2 ユーザープールの作成

1. 右上の「ユーザープールを作成」ボタンをクリック

#### アプリケーションの定義

- **アプリケーションタイプ**: シングルページアプリケーション(SPA)を選択
- **アプリケーション名**: `Simple Weather News Admin`

#### サインイン設定

- **サインイン識別子のオプション**: メールアドレスを選択
- **サインアップのための必須属性**: プルダウンから「Email」を選択

2. 「ユーザーディレクトリを作成する」をクリック

### 1.3 ユーザープール名の変更

1. トーストメッセージが表示されたら閉じる
2. ページ下部にスクロールして「概要に移動」をクリック
3. 「名前変更」をクリック
4. ユーザープール名を変更: `User pool - Simple Weather News Admin`
5. 「変更を保存」をクリック

## 2. Cognito ユーザープールの設定

### 2.1 パスワードポリシーの設定

1. 左側メニューから「認証」→「認証方法」をクリック
2. 「パスワードポリシー」の「編集」をクリック
3. 「カスタム」を選択
4. 最小文字数: 8 文字以上(その他の要件はすべて外す)
5. 「変更を保存」をクリック

### 2.2 サインアップ設定の確認

1. 左側メニューから「サインアップ」をクリック
2. ページ下部の「セルフサービスのサインアップ」が「有効」になっていることを確認
   - ※ユーザーが自らアカウント登録できる設定

### 2.3 アプリケーションクライアントの設定

1. 左側メニューから「アプリケーション」→「アプリケーションクライアント」をクリック
2. 「Simple Weather News Admin」をクリック
3. 右上の「編集」をクリック
4. ✅「ユーザー名とパスワードを使用してサインインします」にチェックを入れる
5. 「変更を保存」をクリック

### 2.4 重要情報のコピー

#### クライアント ID のコピー

- アプリケーションクライアント画面で「クライアント ID」をコピーしてエディタに保存

#### ユーザープール ID のコピー

1. 左側メニューの「概要」をクリック
2. 「ユーザープール ID」をコピーしてエディタに保存

## 3. API Gateway のオーソライザー設定

### 3.1 API Gateway への移動

1. AWS マネジメントコンソールロゴを右クリック → 新しいタブで開く
2. 検索窓に「API Gateway」と入力して移動
3. 「simple-weather-news-api」をクリック

### 3.2 オーソライザーの作成

1. 左側メニューから「Authorization」をクリック
2. 「オーソライザーを管理」タブをクリック
3. 「作成」をクリック

#### オーソライザーの設定

- **オーソライザータイプ**: JWT(JSON Web Token)のまま
- **オーソライザー名**: `simple-weather-news-authorizer`
- **ID ソース**: そのまま
- **発行者 URL**:

  ```
  https://cognito-idp.ap-northeast-1.amazonaws.com/<USER_POOL_ID>
  ```

  ※`<USER_POOL_ID>`の部分を、先ほどコピーしたユーザープール ID(ap-northeast から始まる ID)に置き換える

- **対象者**: 「対象者を追加」をクリックし、先ほどコピーした**クライアント ID**を貼り付ける

4. 「作成」をクリック

### 3.3 オーソライザーのアタッチ

1. 「オーソライザーをルートにアタッチ」タブに戻る

#### /all の GET メソッドにアタッチ

1. 左側から「/all」→「GET」をクリック
2. 「既存のオーソライザーを選択」プルダウンから「simple-weather-news-authorizer」を選択
3. 「オーソライザーをアタッチ」をクリック

#### /{id} の GET メソッドにアタッチ

1. 左側から「/{id}」→「GET」をクリック
2. 「既存のオーソライザーを選択」プルダウンから「simple-weather-news-authorizer」を選択
3. 「オーソライザーをアタッチ」をクリック

#### /{id} の PUT メソッドにアタッチ

1. 左側から「/{id}」→「PUT」をクリック
2. 「既存のオーソライザーを選択」プルダウンから「simple-weather-news-authorizer」を選択
3. 「オーソライザーをアタッチ」をクリック

### 3.4 認証の動作確認

1. 画面上部の「API: simple-weather...」をクリック
2. 「デフォルトのエンドポイント」をクリック

#### /all エンドポイントの確認

- ブラウザで `/all` にアクセス
- **結果**: `Unauthorized` エラーが表示される(認証が必要になった証拠)

#### /{id} エンドポイントの確認

- URL を `/13` に変更してアクセス
- **結果**: 最初は `Unauthorized` エラーが表示される(こちらも認証が必要になった)

## 4. フロントエンド側の動作確認

### 4.1 S3 ホスティングの確認

1. AWS マネジメントコンソールロゴを右クリック → 新しいタブで開く
2. 「S3」サービスに移動
3. 「simple-weather-news-admin」バケットをクリック
4. 「プロパティ」タブから「静的ウェブサイトホスティング」のエンドポイントをクリック

### 4.2 認証なしでのアクセス確認

- メールアドレス形式とパスワード(1 文字以上)を入力してサインイン
- **結果**: 全国の天気予報一覧画面でデータが表示されない(401 エラー)

### 4.3 開発者ツールでのエラー確認

1. ブラウザの開発者ツール(F12)を開く
2. コンソールタブで「401」エラーを確認
   - `/all` への GET リクエストが認証エラーになっていることを確認

## まとめ

この段階で以下が完了しました:

- ✅ Cognito ユーザープールの作成と設定
- ✅ API Gateway への JWT 認証(オーソライザー)の設定
- ✅ 全エンドポイント(/all の GET、/{id} の GET/PUT)への認証の適用
- ✅ 認証なしでは API にアクセスできないことの確認

**次のステップ**:

- フロントエンドにサインアップ/サインイン機能を実装
- 認証済みユーザーが API を呼び出せるように修正

# Day6-3

参考:Day6-3 の最終断面については、Day06/simple_weather_admin/Day06-03-end 以下に格納してあります

## 1. サインアップ機能の実装概要

この動画では、フロントエンドに Cognito と連携したサインアップ機能を追加します。

### 実装内容

- フロントエンド側のサインアップ機能は既に Vue.js で実装済み
- Cognito ユーザープール関連の情報を設定ファイルに埋め込む
- サインアップ機能を動作可能にする

**注意**: この段階ではサインアップのみ実装し、サインイン機能は次の動画で実装します

## 2. サインアップ機能の動作確認(修正前)

### 2.1 フロントエンドへのアクセス

1. S3 バケット「simple-weather-news-admin」の静的ウェブサイトホスティング URL にアクセス
2. 「サインアップ」タブをクリック

### 2.2 サインアップの試行

1. メールアドレス欄に任意のメールアドレスを入力(この時点では何でも OK)
2. パスワード欄に 8 文字以上のパスワードを入力(例: `12345678`)
3. パスワード(確認)欄に同じパスワードを入力
4. 「サインアップ」ボタンをクリック

**結果**: 「ユーザープールのクライアント ID が設定されていません」というエラーメッセージが表示される

### フロントエンド側のバリデーション

- パスワードが一致しない場合 → 「パスワードが一致しません」エラー
- パスワードが 8 文字未満の場合 → フロントエンドのバリデーションで弾かれる
- その他の場合 → 「ユーザープールのクライアント ID が設定されていません」エラー

## 3. Vue.js コードの確認

### 3.1 CloudShell の起動

1. AWS マネジメントコンソール右上の CloudShell アイコンをクリック
2. ホームディレクトリから作業ディレクトリに移動:

```bash
cd ~/work-simple-weather-news-admin
```

### 3.2 index.html のコード確認

```bash
vim index.html
```

#### サインアップメソッドの確認

- **ファイル**: `index.html`
- **場所**: JavaScript の後半部分
- **メソッド名**: `signUp()`

**処理内容**:

1. パスワード一致のバリデーション(フロントエンド側)
2. `authService.signUp()` メソッドを呼び出し

### 3.3 JavaScript(js/auth.js)のコード確認

```bash
vim js/auth.js
```

#### Auth サービスの確認

**ファイル上部の処理**:

1. **コンストラクタ**: 画面立ち上げ時に `initializeUserPool()` を実行
2. **initializeUserPool()**: ユーザープール ID とクライアント ID を使ってユーザープールインスタンスを作成
3. **signUp()**: ユーザープール側が用意している `signUp()` メソッドを呼び出し

**設定ファイルの参照**:

- ユーザープール ID: `config.js` の `userPoolId` を参照
- クライアント ID: `config.js` の `clientId` を参照

## 4. 設定ファイルの修正

### 4.1 config.js の編集

```bash
vim js/config.js
```

#### 現在の設定内容

```javascript
userPoolId: 'dummy-user-pool-id',
clientId: 'dummy-client-id',
```

これらのダミー値を、Day6-2 でコピーした実際の値に置き換えます。

### 4.2 ユーザープール ID の設定

1. `i` キーでインサートモードに切り替え
2. `userPoolId` の値(`'dummy-user-pool-id'`)を削除
3. コピーしておいた**ユーザープール ID**を貼り付け(Ctrl + V)

**注意**: ユーザープール ID は `ap-northeast-1_xxxxxxxxx` の形式です

### 4.3 クライアント ID の設定

1. `clientId` の値(`'dummy-client-id'`)を削除
2. コピーしておいた**クライアント ID**を貼り付け(Ctrl + V)

**注意**: ユーザープール ID とクライアント ID を逆に入れないように注意してください

### 4.4 保存

1. `Esc` キーで編集モードを終了
2. `:wq` と入力して保存

## 5. S3 へのファイル同期

### 5.1 S3 バケット名の確認

1. AWS マネジメントコンソールで S3 サービスに移動
2. 「simple-weather-news-admin」バケット名全体をコピー

### 5.2 aws s3 sync コマンドの実行

```bash
aws s3 sync . s3://simple-weather-news-admin-<YOUR-ACCOUNT-ID>/
```

**パラメータ説明**:

- `.`: カレントディレクトリ(~/work-simple-weather-news-admin)
- `s3://バケット名/`: アップロード先の S3 バケット

**結果**: `js/config.js` のみがアップロードされたことが表示される

## 6. サインアップ機能の動作確認(修正後)

### 6.1 ページの再読み込み

1. 静的ウェブサイトホスティング URL にアクセス
2. スーパーリロード(Ctrl + Shift + R または Ctrl + F5)でキャッシュをクリア

### 6.2 サインアップの実行

1. 「サインアップ」タブをクリック
2. **メールアドレス**: 受信可能な実際のメールアドレスを入力
3. **パスワード**: 8 文字以上のパスワードを入力
4. **パスワード(確認)**: 同じパスワードを入力
5. 「サインアップ」ボタンをクリック

**結果**: 「メールに送信された確認コードを入力してください」というメッセージと入力欄が表示される

### 6.3 確認コードの入力

1. 登録したメールアドレス宛に Cognito から確認コードが届く
2. メールに記載された 6 桁の確認コード(例: `816467`)を入力
3. 「確認」ボタンをクリック

**結果**: 「アカウントが確認されました。サインインしてください。」というメッセージが表示される

## 7. Cognito ユーザープールでの確認

### 7.1 ユーザー一覧の確認

1. AWS マネジメントコンソールで Cognito サービスに移動
2. 「simple-weather-news-admin」ユーザープールをクリック
3. 左側メニューから「ユーザー」をクリック

**結果**: 登録したメールアドレスのユーザーが一覧に表示される

### 7.2 ユーザー詳細の確認

- **ユーザー名**: 登録したメールアドレス
- **ステータス**: 確認済み(CONFIRMED)
- **メール検証済み**: true

## 8. サインイン機能の状態

### 8.1 現在の状態

- サインアップ機能: ✅ 実装完了
- サインイン機能: ❌ まだ実装されていない

### 8.2 サインイン画面の動作

現時点では、サインイン画面で以下のような動作になります:

1. 任意のメールアドレスとパスワードを入力
2. 「サインイン」ボタンをクリック
3. 画面遷移は行われる(ダミー実装)
4. しかし、実際には Cognito と連携していない

**注意**: サインイン機能の実装は次の動画(Day6-4)で行います

## CloudShell 上での作業コマンド

```bash
cd ~/work-simple-weather-news-admin
vim js/config.js
aws s3 sync . s3://your-bucket-name/
```

## まとめ

この段階で以下が完了しました:

- ✅ Vue.js で実装されたサインアップ機能のコード確認
- ✅ config.js にユーザープール ID とクライアント ID を設定
- ✅ Cognito と連携したサインアップ機能の動作確認
- ✅ メール確認コードによるアカウント確認
- ✅ Cognito ユーザープールでのユーザー登録確認

**次のステップ**:

- サインイン機能の実装(Day6-4)
- 認証トークンを使った API 呼び出しの実装

# Day6-4

参考：Day6-4 の最終断面については、Day06/simple_weather_admin/Day06-04-end 以下に格納してあります

## 1. サインイン機能の実装概要

### 実装内容

- 前回実装したサインアップ機能に続き、サインイン機能を実装
- コメントアウトされているサインイン処理を有効化
- Cognito ユーザープールでの認証を通じたログイン機能を完成

**注意**: サインアップは前回完了済み。今回はサインイン機能のみを実装します。

## 2. 現在のコード実装の確認

### 2.1 CloudShell での作業開始

```bash
cd ~/work-simple-weather-news-admin
```

### 2.2 index.html のコード確認

#### 現在のサインイン処理の状態

**現在の実装**:

- サインイン機能は既に Vue.js で実装済み
- ただし、`authService.signIn()` の呼び出し部分がコメントアウトされている
- そのため、どんな入力でも `list.html` に遷移してしまう状態

## 3. サインイン機能の有効化

### 3.1 index.html の修正

```bash
vim index.html
```

#### 修正箇所の特定

1. ファイル内で「Day6-4」に関するコメントを検索
2. 大体 150-160 行目あたりの以下のコメント箇所を探す:

```html
// Day6-4でコメントアウトを外しましょう
```

#### コメントアウトの解除

1. `i` キーでインサートモードに切り替え
2. `//` を削除して `authService.signIn()` メソッドの呼び出しを有効化
3. `Esc` キーで編集モードを終了
4. `:wq` で保存

**修正前**:

```javascript
// await authService.signIn(this.signInForm.email, this.signInForm.password);
```

**修正後**:

```javascript
await authService.signIn(this.signInForm.email, this.signInForm.password);
```

## 4. S3 への修正ファイルのアップロード

### 4.1 ファイル同期の実行

```bash
aws s3 sync . s3://your-bucket-name/
```

**結果**: `index.html` のみがアップロードされたことが表示される

## 5. サインイン機能の動作確認

### 5.1 ページの再読み込み

1. 静的ウェブサイトホスティング URL にアクセス
2. スーパーリロード(Ctrl + Shift + R)でキャッシュをクリア

### 5.2 無効な認証情報でのテスト

1. 「サインイン」タブを選択
2. **メールアドレス**: 適当なメールアドレス（@マークを含む）を入力
3. **パスワード**: 適当なパスワードを入力
4. 「サインイン」ボタンをクリック

**結果**: 「Incorrect username or password」エラーメッセージが表示される

### 5.3 正しい認証情報でのサインイン

1. **メールアドレス**: 前回サインアップで登録したメールアドレスを入力
2. **パスワード**: 前回サインアップで設定したパスワードを入力
3. 「サインイン」ボタンをクリック

**結果**: 一覧画面（list.html）に正常に遷移される

## 6. 認証状態の確認

### 6.1 現在の状態

- ✅ サインアップ機能: 実装完了
- ✅ サインイン機能: 実装完了
- ❌ 認証トークンを使った API 呼び出し: まだ未実装

### 6.2 一覧画面での確認

**現在の動作**:

- サインインは成功するが、一覧画面で API からデータを取得できない
- これは、ログイン時に取得した JSON Web Token を使って API 呼び出しを行っていないため

**理由**: API Gateway に設定したオーソライザーにトークンを渡していないため、認証エラーが発生

## CloudShell 上での作業コマンド

```bash
cd ~/work-simple-weather-news-admin
vim index.html
aws s3 sync . s3://your-bucket-name/
```

## まとめ

この段階で以下が完了しました:

- ✅ サインイン機能のコメントアウト解除
- ✅ Cognito ユーザープールとの認証連携
- ✅ 正しい認証情報でのログイン成功確認
- ✅ 無効な認証情報での適切なエラー表示確認
- ✅ ログイン画面の完成

**次のステップ**:

- 認証トークンを使った API 呼び出しの実装（Day6-5）
- 一覧画面でのデータ表示機能の修正

# Day6-5

参考：Day6-5 の最終断面については、Day06/simple_weather_admin/Day06-05-end 以下に格納してあります

## 1. 認証トークンを使った API 呼び出しの実装概要

### 実装内容

- 一覧画面（list.html）での認証トークンを使った API 呼び出し機能の実装
- ログイン状態のチェック機能の追加
- ログアウト機能の実装

### 現在の課題

- ログイン済みでも認証トークンを含めずに API を呼び出してしまう（401 エラー）
- ログインしていなくても list.html に直接遷移できてしまう
- ログアウトボタンが未実装

## 2. 現在の動作確認

### 2.1 ブラウザでの確認

1. 前回のログイン状態のままブラウザでリロード
2. **結果**: データが表示されない（404 エラー = 認証エラー）
3. ログアウトボタンをクリック
4. **結果**: 何も反応しない（未実装のため）

## 3. コードの確認と修正

### 3.1 CloudShell での作業開始

```bash
cd ~/work-simple-weather-news-admin
vim list.html
```

### 3.2 list.html のコード構造確認

#### mounted() メソッドの確認

**現在の状態**:

- 画面描画時に実行される`mounted()`内の認証チェック処理がコメントアウトされている
- `authService.isAuthenticated()`で認証状態を確認する処理が無効化されている

#### isAuthenticated() メソッドの役割

**js/auth.js 内の処理**:

- JSON Web Token の存在確認
- 認証状態の判定

#### signOut() メソッドの役割

**js/auth.js 内の処理**:

- 現在のユーザーをサインアウト
- ローカルストレージの JSON Web Token を削除

### 3.3 list.html の修正作業

#### 3.3.1 認証チェック処理の有効化

1. `i` キーでインサートモードに切り替え
2. `mounted()`メソッド内の「Day6-5 でコメントアウトを外す」箇所を探す
3. 以下の行のコメントアウト（`//`）を削除:

```javascript
/*
if (!authService. isAuthenticated()) {
   window. location.href = 'index.html';
   return;
}
*/
```

**修正後**:

```javascript
if (!authService.isAuthenticated()) {
  window.location.href = "index.html";
  return;
}
```

#### 3.3.2 API 呼び出し処理の修正

1. `fetchWeatherData()`メソッド内の現在の API 呼び出し処理をコメントアウト

```javascript
const response = await fetch(`${CONFIG.API_BASE_URL}/all`);
```

2. その下の「Day6-5 でコメントアウトを外す」箇所のコメントアウトを削除

```javascript
const response = await fetch(`${CONFIG.API_BASE_URL}/all`, {
  headers: {
    Authorization: `Bearer ${authService.getAccessToken()}`,
  },
});
if (response.status === 401) {
  authService.signOut();
  window.location.href = "index.html";
  return;
}
```

#### 3.3.3 ログアウト機能の有効化

1. `logout()`メソッドのコメントアウトを削除:

**修正後**:

```javascript
logout() {
    authService.signOut();
    window.location.href = 'index.html';
}
```

### 3.4 ファイルの保存

1. `Esc` キーで編集モードを終了
2. `:wq` で保存

## 4. S3 への修正ファイルのアップロード

### 4.1 ファイル同期の実行

```bash
aws s3 sync . s3://your-bucket-name/
```

**結果**: `list.html` のみがアップロードされることを確認

## 5. 修正後の動作確認

### 5.1 ログイン機能の確認

1. 静的ウェブサイトホスティング URL にアクセス
2. URL から `/list.html` 部分を削除してトップページに戻る
3. 登録済みのメールアドレスとパスワードでサインイン

**結果**: 一覧画面で API からのデータが正常に表示される

### 5.2 ログアウト機能の確認

1. 一覧画面で「ログアウト」ボタンをクリック
2. **結果**: ログインページ（index.html）に遷移

### 5.3 認証チェック機能の確認

1. ログアウト状態で `list.html` に直接アクセス
2. **結果**: 一瞬画面が表示された後、自動的にログインページに戻る

### 5.4 認証状態の維持確認

1. ログイン後、新しいタブで `list.html` にアクセス
2. **結果**: ローカルストレージにアクセストークンがあるため、正常に画面表示

## 6. 実装された機能

### 6.1 認証チェック機能

- 画面表示時に自動的に認証状態をチェック
- 未認証の場合は自動的にログインページにリダイレクト

### 6.2 認証トークン付き API 呼び出し

- API リクエストのヘッダーに Bearer トークンを付与
- 401 エラー時の自動サインアウト処理

### 6.3 ログアウト機能

- ログアウトボタンの実装
- ローカルストレージからのトークン削除
- ログインページへの自動遷移

## CloudShell 上での作業コマンド

```bash
cd ~/work-simple-weather-news-admin
vim list.html
aws s3 sync . s3://your-bucket-name/
```

## まとめ

この段階で以下が完了しました:

- ✅ 一覧画面での認証チェック機能
- ✅ 認証トークンを使った API 呼び出し
- ✅ ログアウト機能の実装
- ✅ 認証エラー時の自動サインアウト処理
- ✅ 未認証時の自動リダイレクト機能

**次のステップ**:

- 詳細画面（detail.html）での認証トークンを使った API 呼び出しの実装（Day6-6）

**注意**: 現在詳細画面では、まだ認証トークンを付けずに API を呼び出しているため、401 エラーが発生しています

# Day6-6

## 1. 詳細画面（detail.html）の認証機能実装概要

### 実装内容

- 詳細画面での認証チェック機能の追加
- 認証トークンを使った API 呼び出し機能の実装
- 未認証時の自動リダイレクト機能の追加

### 現在の課題

- ログイン済みでも認証トークンを含めずに API を呼び出してしまう（401 エラー）
- ログインしていなくても detail.html に直接遷移できてしまう
- ログアウトボタンが未実装

## 2. 現在の動作確認

### 2.1 詳細画面での問題確認

1. 一覧画面から天気予報詳細（例：札幌）をクリック
2. **結果**: API が正常に呼び出せない（401 エラー）
3. 詳細画面で「ログアウト」ボタンを確認
4. **結果**: ボタンが未実装で動作しない

### 2.2 直接遷移の問題確認

1. 詳細画面の URL をコピー
2. 一覧画面でログアウト
3. コピーした URL を直接ブラウザで開く
4. **結果**: 認証チェックなしで詳細画面にアクセスできてしまう

## 3. CloudShell での修正作業

### 3.1 作業環境の準備

```bash
cd ~/work-simple-weather-news-admin
vim detail.html
```

### 3.2 detail.html の修正作業

#### 3.2.1 認証チェック処理の有効化

1. `i` キーでインサートモードに切り替え
2. Vue.js の `mounted()` メソッド内で認証チェック処理のコメントアウトを削除

**修正箇所**: mounted() 内の以下の処理

**修正前**:

```javascript
/*
if (!authService.isAuthenticated()) {
   window.location.href = 'index.html';
   return;
}
*/
```

**修正後**:

```javascript
if (!authService.isAuthenticated()) {
  window.location.href = "index.html";
  return;
}
```

#### 3.2.2 API 呼び出し処理の修正

1. `fetchCityData()` メソッド内の現在の API 呼び出し処理をコメントアウト

**修正前**:

```javascript
const response = await fetch(`${CONFIG.API_BASE_URL}/${cityId}`);
```

**修正後**:

```javascript
// const response = await fetch(`${CONFIG.API_BASE_URL}/${cityId}`);
```

2. その下の「Day6-6 でコメントアウトを外す」箇所のコメントアウトを削除

**修正後**:

```javascript
const response = await fetch(`${CONFIG.API_BASE_URL}/${this.cityId}`, {
  headers: {
    Authorization: `Bearer ${authService.getAccessToken()}`,
  },
});
if (response.status === 401) {
  // 認証エラー時はログアウトしてログイン画面に戻る
  authService.signOut();
  window.location.href = "index.html";
  return;
}
```

### 3.3 ファイルの保存

1. `Esc` キーで編集モードを終了
2. `:wq` で保存

## 4. S3 への修正ファイルのアップロード

### 4.1 ファイル同期の実行

```bash
aws s3 sync . s3://your-bucket-name/
```

**結果**: `detail.html` のみがアップロードされることを確認

## 5. 修正後の動作確認

### 5.1 正常な認証時の動作確認

1. 静的ウェブサイトホスティング URL にアクセス
2. 登録済みのメールアドレスとパスワードでサインイン
3. 一覧画面から天気予報詳細（例：札幌）をクリック
4. **結果**: API からのデータが正常に表示される（例：「曇り 70%」）

### 5.2 認証チェック機能の確認

1. 詳細画面の URL をコピー
2. 一覧画面に戻ってログアウト
3. コピーした詳細画面の URL を直接ブラウザで開く
4. **結果**: 「あなたは JSON Web Token を持っていないので、最初からやり直してください」→ index.html に自動リダイレクト

### 5.3 キャッシュクリアの必要性

- ブラウザのキャッシュが残っている場合は、強制リロード（Ctrl + Shift + R）を実行
- 修正が反映されない場合は、スーパーリロードでキャッシュをクリア

## 6. 実装された機能

### 6.1 認証チェック機能

- 詳細画面表示時に自動的に認証状態をチェック
- 未認証の場合は自動的にログインページにリダイレクト

### 6.2 認証トークン付き API 呼び出し

- 詳細データ取得 API リクエストのヘッダーに Bearer トークンを付与
- 401 エラー時の自動サインアウト処理

### 6.3 セキュリティ向上

- 直接 URL アクセスの制限
- 認証状態の確認による適切な画面制御

## 7. 残りの課題

以下の機能は次の動画（Day6-7）で実装予定です：

- ❌ 詳細画面でのログアウト機能
- ❌ 天気予報データの更新機能（PUT API の呼び出し）

## CloudShell 上での作業コマンド

```bash
cd ~/work-simple-weather-news-admin
vim detail.html
aws s3 sync . s3://your-bucket-name/
```

## まとめ

この段階で以下が完了しました:

- ✅ 詳細画面での認証チェック機能
- ✅ 認証トークンを使った詳細データ取得 API 呼び出し
- ✅ 未認証時の自動リダイレクト機能
- ✅ 認証エラー時の自動サインアウト処理
- ✅ 直接 URL アクセスの制限

**次のステップ**:

- 詳細画面でのログアウト機能の実装（Day6-7）
- 天気予報データの更新機能の実装（Day6-7）

# Day6-7

参考：Day6-7 の最終断面については、Day06/simple_weather_admin/Day06-07-end 以下に格納してあります

## 1. 詳細画面の残りの課題への対応

### 実装内容

- 詳細画面でのログアウト機能の実装
- 天気予報データの更新機能（PUT API 呼び出し）での認証トークン対応

### 現在の課題

- 詳細画面のログアウトボタンが未実装
- 天気予報データの更新時に認証トークンを含めずに PUT API を呼び出してしまう（401 エラー）

## 2. CloudShell での修正作業

### 2.1 作業環境の準備

```bash
cd ~/work-simple-weather-news-admin
vim detail.html
```

### 2.2 detail.html の修正作業

#### 2.2.1 updateWeather() メソッドの修正

1. `i` キーでインサートモードに切り替え
2. `updateWeather()` メソッド内で現在の PUT API 呼び出し処理を確認

**現在の実装**:

- 認証ヘッダーを含めずに PUT API を呼び出している
- そのため更新時に 401 エラーが発生する

3. 認証ヘッダーを含めた PUT API 呼び出し処理のコメントアウトを削除

**修正箇所**: updateWeather() メソッド内

**修正前**:

```javascript
const response = await fetch(`${CONFIG.API_BASE_URL}/${this.cityId}`, {
  method: "PUT",
  headers: {
    "Content-Type": "application/json",
  },
  body: JSON.stringify({
    weather: this.weather,
    precipitation: this.precipitation,
  }),
});
```

**修正後** (コメントアウトを削除):

```javascript
const response = await fetch(`${CONFIG.API_BASE_URL}/${this.cityId}`, {
  method: "PUT",
  headers: {
    "Content-Type": "application/json",
    Authorization: `Bearer ${authService.getAccessToken()}`,
  },
  body: JSON.stringify({
    weather: this.weather,
    precipitation: this.precipitation,
  }),
});
```

#### 2.2.2 401 エラー時の処理を追加

1. updateWeather() メソッド内で、401 エラー時の自動サインアウト処理のコメントアウトを削除

**追加する処理**:

```javascript
if (response.status === 401) {
  // 認証エラー時はログアウトしてログイン画面に戻る
  authService.signOut();
  window.location.href = "index.html";
  return;
}
```

#### 2.2.3 ログアウト機能の実装

1. `logout()` メソッドのコメントアウトを削除

**修正後**:

```javascript
logout() {
    authService.signOut();
    window.location.href = 'index.html';
}
```

### 2.3 ファイルの保存

1. `Esc` キーで編集モードを終了
2. `:wq` で保存

## 3. S3 への修正ファイルのアップロード

### 3.1 ファイル同期の実行

```bash
aws s3 sync . s3://your-bucket-name/
```

**結果**: `detail.html` のみがアップロードされることを確認

## 4. 修正後の動作確認

### 4.1 ログイン後のデータ更新確認

1. 静的ウェブサイトホスティング URL にアクセス
2. 登録済みのメールアドレスとパスワードでサインイン
3. 一覧画面から天気予報詳細（例：札幌）をクリック
4. 天気を「晴れ」、降水確率を「0」%に変更
5. 「更新」ボタンをクリック

**結果**: 「札幌の天気を更新しました」というメッセージが表示される

### 4.2 データ更新の反映確認

1. 一覧画面に戻る
2. **結果**: 札幌の天気が「晴れ 0%」に更新されていることを確認

### 4.3 別の都市での更新確認

1. 東京の詳細をクリック
2. 天気を「雨」、降水確率を「100」%に変更
3. 「更新」ボタンをクリック

**結果**: 「東京の天気を更新しました」というメッセージが表示される

### 4.4 データ永続化の確認

1. 一覧画面に戻る
2. **結果**: 東京の天気が「雨 100%」に更新されていることを確認
3. ページを再読み込みしても変更が保持されていることを確認

### 4.5 詳細画面でのログアウト機能確認

1. 詳細画面で「ログアウト」ボタンをクリック
2. **結果**: ログインページ（index.html）に正常に遷移

## 5. 実装された機能

### 5.1 認証トークン付きデータ更新機能

- PUT API リクエストのヘッダーに Bearer トークンを付与
- 天気予報データの更新が正常に動作

### 5.2 401 エラー時の処理

- データ更新時の認証エラーに対する自動サインアウト処理
- 適切なエラーハンドリング

### 5.3 詳細画面でのログアウト機能

- ログアウトボタンの実装
- ローカルストレージからのトークン削除
- ログインページへの自動遷移

### 5.4 データの永続化

- DynamoDB への正常なデータ保存
- ページ再読み込み時のデータ保持

## 6. Day6 のハンズオン完了

### 6.1 実装完了した機能

- ✅ Cognito ユーザープールでの認証・認可
- ✅ サインアップ機能（メール確認付き）
- ✅ サインイン機能
- ✅ 認証トークンを使った API 呼び出し
- ✅ 一覧画面での認証チェック・ログアウト機能
- ✅ 詳細画面での認証チェック・ログアウト機能
- ✅ 天気予報データの参照・更新機能
- ✅ 認証エラー時の自動サインアウト処理

### 6.2 セキュリティ機能

- ✅ 未認証ユーザーの API アクセス制限
- ✅ JWT トークンによる認証・認可
- ✅ 直接 URL アクセスの制限
- ✅ トークン有効期限切れ時の適切な処理

## CloudShell 上での作業コマンド

```bash
cd ~/work-simple-weather-news-admin
vim detail.html
aws s3 sync . s3://your-bucket-name/
```

## まとめ

Day6 で実施予定だった Amazon Cognito と連携した認証・認可機能のすべてのハンズオンが完了しました。

- ✅ Amazon Cognito ユーザープールの作成・設定
- ✅ API Gateway への JWT オーソライザーの設定
- ✅ Vue.js を使ったシングルページアプリケーションでの認証機能実装
- ✅ Simple Weather News Admin 機能との完全な連携

これにより、セキュアな Web アプリケーションとして、認証済みユーザーのみが天気予報データの参照・更新を行えるシステムが完成しました。

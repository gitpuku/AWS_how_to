# VPC エンドポイントを使用した S3 アクセスのラボ

## 対象者

- クラウドアーキテクト
- クラウドネットワークエンジニア

## 対象カテゴリ

- コンピューティング
- ネットワーキング

アーキテクチャ
![alt text](01.png)

---

## タスク 1: AWS マネジメントコンソールへのサインイン

1. **Open Console**ボタンをクリックし、新しいブラウザタブで AWS コンソールにリダイレクトされます。

2. AWS サインインページで、以下の手順を実行します:

   - アカウント ID はデフォルトのままにします。12 桁のアカウント ID を編集または削除しないでください。削除するとラボを続行できなくなります。
   - ラボコンソールから**ユーザー名**と**パスワード**をコピーし、AWS コンソールの**IAM ユーザー名とパスワード**に貼り付けて、**サインイン**ボタンをクリックします。

3. AWS マネジメントコンソールにサインインしたら、デフォルトの AWS リージョンを**米国(バージニア北部)us-east-1**に設定します。

---

## タスク 2: VPC の作成

1. **バージニア北部**リージョンにいることを確認します。

2. 上部の**サービス**メニューをクリックし、**ネットワーキングとコンテンツ配信**セクションの**VPC**をクリックして、VPC に移動します。

3. VPC を作成するには、左サイドバーの**仮想プライベートクラウド**セクションにある**VPC**をクリックします。

4. **VPC を作成**ボタンをクリックして、新しい VPC を作成します。

5. 以下の設定を入力します:

   - **VPC のみ**を選択
   - **名前タグ - オプション**: `MyVPC`
   - **IPv4 CIDR ブロック**: `192.168.0.0/26`
   - **IPv6 CIDR ブロック**: IPv6 CIDR ブロックなし
   - **テナンシー**: デフォルト

6. **VPC を作成**ボタンをクリックして**MyVPC**を作成します。

7. VPC が作成されました。

---

## タスク 3: インターネットゲートウェイの作成とカスタム VPC へのアタッチ

1. デフォルトでは、VPC で起動されたインスタンスはインターネットと通信できません。インターネットアクセスを有効にするには、インターネットゲートウェイを VPC にアタッチする必要があります。

2. 左メニューから**インターネットゲートウェイ**をクリックし、**インターネットゲートウェイの作成**をクリックします。

3. 以下の設定を入力します:

   - **名前タグ**: `MyInternetGateway`
   - **インターネットゲートウェイの作成**をクリック

4. 作成したインターネットゲートウェイをリストから選択します。

   - **アクション**をクリック
   - **VPC にアタッチ**を選択

5. **使用可能な VPC**: **MyVPC**を選択

6. **インターネットゲートウェイのアタッチ**ボタンをクリックします。

7. インターネットゲートウェイが MyVPC にアタッチされました。

---

## タスク 4: パブリックサブネットとプライベートサブネットの作成

1. サブネットを作成するには、左サイドバーの**仮想プライベートクラウド**セクションにある**サブネット**をクリックします。

2. **サブネットを作成**ボタンをクリックします。

3. VPC ID で**MyVPC**を選択します。

4. 最初のサブネットを作成します。このサブネットはパブリックインスタンスを起動するために使用され、VPC のメインルートテーブルに関連付けられます:

   - ドロップダウンから**MyVPC**を選択
   - **サブネット名**: `MyPublicSubnet`
   - **アベイラビリティゾーン**: **US East (N. Virginia) / us-east-1a**を選択
   - **IPv4 CIDR ブロック**: `192.168.0.0/27`
   - **サブネットを作成**ボタンをクリックしてサブネットを作成

5. もう 1 つのサブネットを作成します。**サブネットを作成**ボタンをクリックします。

6. 2 番目のサブネットは Private subnet と呼ばれ、プライベートインスタンスを起動するために使用され、同じ VPC のカスタムルートテーブルに関連付けられます:

   - ドロップダウンから**MyVPC**を選択
   - **サブネット名**: `MyPrivateSubnet`
   - **アベイラビリティゾーン**: **US East (N. Virginia) / us-east-1b**を選択
   - **IPv4 CIDR ブロック**: `192.168.0.32/27`

7. 最後に、**サブネットを作成**ボタンをクリックします。

8. 両方のサブネットが作成されました。

---

## タスク 5: パブリックサブネットでパブリック IPv4 アドレスの自動割り当てを有効にする

1. パブリックサブネットの自動割り当て IP 設定を変更するには、以下の手順を実行します:

   - **MyPublicSubnet**を選択
   - **アクション**ボタンをクリック
   - オプションから**サブネット設定を編集**を選択

2. **自動割り当て IP 設定**の下にある**パブリック IPv4 アドレスの自動割り当てを有効化**オプションをチェックします。

3. **保存**ボタンをクリックして変更が完了しました。

---

## タスク 6: パブリックサブネット用のルートテーブルの作成

このタスクでは、パブリックルートテーブルを作成し、サブネットに関連付けます。

1. 左メニューから**ルートテーブル**に移動し、**ルートテーブルを作成**ボタンをクリックします。

   - **名前**: `PublicRouteTable`
   - **VPC**: リストから**MyVPC**を選択
   - **ルートテーブルを作成**ボタンをクリック

2. プライベートサブネット用のルートテーブルを作成するために、同じ手順を繰り返します。

   - **名前**: `PrivateRouteTable`
   - **VPC**: リストから**MyVPC**を選択
   - **ルートテーブルを作成**ボタンをクリック

3. サブネットをルートテーブルに関連付けます。

4. **PublicRouteTable**を選択し、**サブネットの関連付け**タブに移動します。

   - **サブネットの関連付けを編集**をクリック
   - リストから**MyPublicSubnet**を選択
   - **関連付けを保存**ボタンをクリック

5. **PrivateRouteTable**を選択し、**サブネットの関連付け**タブに移動します。

   - **サブネットの関連付けを編集**をクリック
   - リストから**MyPrivateSubnet**を選択
   - **関連付けを保存**ボタンをクリック

6. **メインルートテーブル**にサブネットを関連付けないでください。

7. **PublicRouteTable**: インターネットトラフィックを VPC に許可するルートを追加します。
   - **PublicRouteTable**を選択
   - **ルート**タブに移動し、**ルートを編集**をクリックし、次のページで**ルートを追加**ボタンをクリック
   - 以下の値を指定:
     - **送信先**: `0.0.0.0/0`
     - **ターゲット**: ドロップダウンメニューから**インターネットゲートウェイ**を選択し、**MyInternetGateway**を選択
     - **変更を保存**ボタンをクリック

---

## タスク 7: セキュリティグループの作成

1. このラボでは、2 つのセキュリティグループを作成します。**最初のものは Bastion ホスト用**で、**2 番目のものは S3 の VPC エンドポイントにアクセスできるプライベートインスタンス用**です。

2. セキュリティグループの作成を開始するには、左サイドバーの**セキュリティ**セクションにある**セキュリティグループ**をクリックします。

3. **セキュリティグループを作成**ボタンをクリックします。

4. **基本的な詳細**の下に以下の詳細を入力します:

   - **セキュリティグループ名**: `Bastion-SG`
   - **説明**: `Security group for the bastion host`
   - **VPC**フィールドで**MyVPC**を選択

5. デフォルトでは、インバウンドルールは許可されず、アウトバウンドルールを確認すると、**すべてのトラフィック**タイプのルールが 1 つだけあります。これは**セキュリティグループがステートフル**な性質であるためです。**インバウンドが許可されると、アウトバウンドも許可されます。**

6. インバウンドルールを追加するには、**ルールを追加**ボタンをクリックします。

7. Bastion ホストセキュリティグループに**3 つのルール**を追加します。つまり、**SSH、HTTP、HTTPS**です。

   - 最初のルール: **タイプ**を**SSH**、**ソース**を**Anywhere-IPv4**として選択し、`0.0.0.0/0`を入力
   - 2 番目のルール: **ルールを追加**ボタンをクリック。**タイプ**を**HTTP**、**ソース**を**Anywhere-IPv4**として選択し、`0.0.0.0/0`を入力
   - 3 番目のルール: **ルールを追加**ボタンをクリック。**タイプ**を**HTTPS**、**ソース**を**Anywhere-IPv4**として選択し、`0.0.0.0/0`を入力

8. 最後に、**セキュリティグループを作成**ボタンをクリックします。

9. Bastion ホスト用のセキュリティグループが作成されました。

10. 左サイドバーの**セキュリティ**セクションにある**セキュリティグループ**ボタンをクリックします。

11. 2 番目のセキュリティグループを作成するには、**セキュリティグループを作成**ボタンをクリックします。

12. **基本的な詳細**の下に以下の詳細を入力します:

    - **セキュリティグループ名**: `Endpoint-SG`
    - **説明**: `Security group for S3 endpoint`
    - **VPC**フィールドで**MyVPC**を選択

13. インバウンドルールを追加するには、**ルールを追加**ボタンをクリックします。

14. S3 エンドポイントセキュリティグループに**1 つのルール**を追加します。つまり、**SSH のみ**です。ただし、ここでのソースは**Bastion ホストセキュリティグループ**になります。**Bastion-SG**セキュリティグループの ID を選択します。

    - ルールの場合: **タイプ**を**SSH**として選択し、**ソース**を**カスタム**として選択し、**Bastion**と入力すると、Bastion ホストセキュリティグループが表示されるので、そのセキュリティグループを選択

15. 最後に、**セキュリティグループを作成**ボタンをクリックします。

16. Bastion ホスト用のセキュリティグループが作成され、リストに表示されます。

---

## タスク 8: Bastion ホスト(パブリックにアクセス可能な EC2 インスタンス)の作成

1. 上部の**サービス**メニューをクリックし、**コンピューティング**セクションの**EC2**をクリックして、EC2 に移動します。

2. 左パネルの**インスタンス**に移動し、**インスタンスを起動**をクリックします。

3. **名前**: `Bastion-host`を入力

4. **Amazon Machine Image (AMI)**: 検索ボックスで**Amazon Linux 2023 AMI**を検索し、**選択**ボタンをクリックします。

5. **注意: Amazon Linux 2023 AMI に 2 つの AMI がある場合は、kernel-6.1 AMI を選択してください。**

6. **インスタンスタイプ**: `t2.micro`を選択

7. **キーペア**: **新しいキーペアを作成**ボタンを選択

   - **キーペア名**: `WhizKey`
   - **キーペアタイプ**: **RSA**
   - **プライベートキーファイル形式**: **.pem**

8. **キーペアを作成**ボタンを選択します。

9. **ネットワーク設定**で**編集**ボタンをクリック:

   - **VPC**: **MyVPC**を選択
   - **サブネット**: **MyPublicSubnet**を選択
   - **パブリック IP の自動割り当て**: **有効化**
   - **既存のセキュリティグループを選択**を選択
   - **セキュリティグループ名**: **Bastion-SG**を選択

10. その他はデフォルトのままにして、**インスタンスを起動**ボタンをクリックします。

11. **すべてのインスタンスを表示**を選択して、作成したインスタンスを表示します。

12. **起動ステータス**: インスタンスが起動中です。インスタンス ID をクリックし、ステータスが**実行中**に変わるまで、インスタンスの完全な初期化を待ちます。

---

## タスク 9: エンドポイントインスタンス(プライベートにアクセス可能な EC2 インスタンス)の作成

1. 上部の**サービス**メニューをクリックし、**コンピューティング**セクションの**EC2**をクリックして、EC2 に移動します。

2. 左パネルの**インスタンス**に移動し、**インスタンスを起動**をクリックします。

3. **名前**: `Endpoint-instance`を入力

4. **Amazon Machine Image (AMI)**: 検索ボックスで**Amazon Linux 2023 AMI**を検索し、**選択**ボタンをクリックします。

5. **注意: Amazon Linux 2023 AMI に 2 つの AMI がある場合は、kernel-6.1 AMI を選択してください。**

6. **インスタンスタイプ**: `t2.micro`を選択

7. **キーペア**: 前のタスクで作成したキーペアを選択します。

8. **ネットワーク設定**で**編集**ボタンをクリック:

   - **VPC**: **MyVPC**を選択
   - **サブネット**: **MyPrivateSubnet**を選択
   - **既存のセキュリティグループを選択**を選択
   - **セキュリティグループ名**: **Endpoint-SG**を選択

9. その他はデフォルトのままにして、**インスタンスを起動**ボタンをクリックします。

10. **すべてのインスタンスを表示**を選択して、作成したインスタンスを表示します。

11. **起動ステータス**: インスタンスが起動中です。インスタンス ID をクリックし、ステータスが**実行中**に変わるまで、インスタンスの完全な初期化を待ちます。

12. **インスタンス**に移動し、1〜2 分待ちます(**Endpoint-instance**のステータスが**保留中**から**実行中**状態に変わるまで)。

---

## タスク 10: Bastion ホストを経由してエンドポイントインスタンス(プライベートにアクセス可能)に SSH 接続する

1. Bastion PEM キー(**WhizKey.pem**)を使用して Bastion インスタンスに SSH 接続します。  
   ローカルや Cloudshell で下記を実行

```bash
ssh -i WhizKey.pem ec2-user@パブリックIPアドレス
```

2. **Bastion インスタンス経由でエンドポイントインスタンスに SSH 接続**するには、**WhizKey.pem**が**Bastion インスタンス**に存在する必要があります。

3. ローカルシステムで**WhizKey.pem**ファイルを開き、**テキストコンテンツをコピー**します。

4. Bastion インスタンスに移動し、以下のコマンドを使用して**WhizKey.pem**という名前のファイルを作成します:

```bash
vi WhizKey.pem
```

5. **i**を押して**WhizKey.pem**の内容を貼り付けます。**Esc キー**を押して保存し、**:wq**と入力して**Enter**を押します。

6. キーファイルの権限を**400**に変更したことを確認してください。以下のコマンドを使用して権限を変更できます:

```bash
chmod 400 WhizKey.pem
```

7. これで、以下のコマンドを使用して、Bastion サーバーにコピーされた秘密鍵を使用して**Web サーバーにログイン**できます。

   - **注意**: プライベート**サブネット**で作成したため、エンドポイントインスタンスの**パブリック IP がありません**。
   - 構文: `ssh -i WhizKey.pem ec2-user@<エンドポイントインスタンスのプライベートIP>`
   - 例: `ssh -i WhizKey.pem ec2-user@192.168.0.55`
   - 確認を求められたら、次のように入力します: **yes**

8. 以下のコマンドを入力します: **aws configure**
   - **アクセスキー**: 提供されたアクセスキーを貼り付けます
   - **シークレットキー**: 提供されたシークレットキーを貼り付けます
   - **デフォルトリージョン名**: us-east-1
   - **デフォルト出力形式**: Enter [**ENTER**]

> **注意**: 割り当てられた IAM ロールに S3 読み取りアクセス権があるにもかかわらず、AWS CLI コマンドを使用してバケットをリストしようとすると、S3 のエンドポイントで接続タイムアウトと表示されて失敗しました。

9. このインスタンスのセキュリティグループは SSH のみを許可しているため、他のコマンドを実行すると失敗します。

10. VPC エンドポイント for S3 を使用して S3 エンドポイントにアクセスする権限を追加しましょう。

---

## タスク 11: S3 用の VPC エンドポイントを作成し、プライベートサブネットのルートテーブルにアタッチする

1. 上部の**サービス**メニューをクリックし、**ネットワーキングとコンテンツ配信**セクションの**VPC**をクリックして、VPC に移動します。

2. **PrivateLink と Lattice**の下にある**エンドポイント**をクリックします。

3. **エンドポイントを作成**ボタンをクリックします。

4. **サービスカテゴリ**が**AWS サービス**に選択されていることを確認します。**サービス名**検索バーに**s3**と入力し、**Enter**を押します。

5. **タイプ**が**Gateway**で、サービス名が**com.amazonaws.us-east-1.s3**のエンドポイントを選ぶ。

6. VPC を変更し、**MyVPC**を選択します。

7. 名前が**PrivateRouteTable**のルートテーブルのオプションをチェックします。  
   ※タイプが Gateway の com.amazonaws.us-east-1.s3 を選んでなかったら表示されないことに注意

8. 最後に、**エンドポイントを作成**ボタンをクリックします。

9. **エンドポイント**が作成されます。

10. **閉じる**ボタンをクリックすると、しばらくすると**エンドポイント**がリストされます。

11. (オプション)エンドポイントがカスタムルートテーブル(プライベートサブネット用の RT)に関連付けられているかどうかを確認するには、ルートテーブルに移動し、カスタムルートテーブルを選択して、下の**ルート**オプションをクリックすると、S3 のエントリが表示されます。

---

## タスク 12: すべての S3 バケットとそのオブジェクトをリストする

1. **タスク 10**で説明したように、Bastion インスタンスからエンドポイントインスタンスに SSH 接続します。

   **aws configure**を入力します:

   - **アクセスキー**: 提供されたアクセスキーを貼り付けます
   - **シークレットキー**: 提供されたシークレットキーを貼り付けます
   - **デフォルトリージョン名**: us-east-1
   - **デフォルト出力形式**: Enter [**ENTER**]

2. 以下の AWS CLI コマンドを使用して、すべてのバケットをリストします:

```bash
aws s3 ls
```

3. whizlabs で始まる名前の S3 バケットのオブジェクトをリストします。

4. 以下のコマンドの S3 バケット名を置き換えます:

```bash
aws s3 ls s3://whizlabs
```

例えば

```bash
aws s3 ls s3://whizlabs-320757.80141762074408
```

> **ご存知ですか?**
>
> VPC エンドポイントサービスはプライベート接続を可能にし、パブリックインターネットトラフィックに関連するデータ転送料金を回避できます。VPC エンドポイントを使用することで、特に VPC と AWS サービス間に大量のデータフローがある場合、データ転送コストを大幅に削減できます。

---

## タスク 13: 検証テスト

1. ラボの手順が完了したら、右側のパネルの**検証**ボタンをクリックしてください。

2. これにより、AWS アカウント内のリソースが検証され、このラボが正常に完了したかどうかが表示されます。

3. サンプル出力: (検証の進行状況を示す GIF アニメーション)

---

## タスク 14: AWS リソースの削除

### VPC エンドポイントの削除

1. 上部の**サービス**メニューをクリックし、**ネットワーキングとコンテンツ配信**セクションの**VPC**をクリックして、VPC に移動します。

2. 左サイドバーの**仮想プライベートクラウド**セクションにある**エンドポイント**をクリックします。

3. VPC エンドポイントを削除するには、以下のタスクを実行します:

   - エンドポイントを選択
   - **アクション**ボタンをクリック
   - **VPC エンドポイントを削除**のオプションを選択

4. **delete**と入力して削除を確認します。

5. エンドポイントはすぐに削除されます。

### EC2 インスタンスの終了

1. 上部の**サービス**メニューをクリックし、**コンピューティング**セクションの**EC2**をクリックして、EC2 に移動します。

2. 左パネルの**インスタンス**をクリックします。

3. EC2 インスタンスがここにリストされます。

4. 存在する両方のインスタンスを終了するには、以下のタスクを実行します:

   - 両方の**EC2 インスタンス**を選択
   - **インスタンスの状態**をクリック
   - **インスタンスを終了**を選択

5. 選択した両方の EC2 インスタンスの終了を確認するには、**終了**ボタンをクリックします。

6. インスタンスは 1 分ほどで終了されます。

---

## 完了と結論

1. 2 つの EC2 インスタンス、つまり Bastion インスタンスとエンドポイントインスタンスを起動しました。Bastion インスタンス経由でエンドポイントインスタンスに SSH 接続することに成功しました。

2. S3 用の VPC エンドポイントを作成して、エンドポイントインスタンスからインターネットに接続せずに、Amazon のネットワーク内で S3 バケットとそのオブジェクトに安全にアクセスしました。

3. プライベートインスタンスから S3 用の VPC エンドポイントをテストしました。

---

## ラボの終了

1. AWS アカウントからサインアウトします。

2. ラボを正常に完了しました。

3. 手順を完了したら、whizlabs ダッシュボードから**ラボを終了**をクリックしてください。

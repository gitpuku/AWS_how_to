# Day9：Amazon CloudFront と AWS WAF を使ってみる

## 概要

Day9 では、Amazon CloudFront という CDN（コンテンツデリバリーネットワーク）サービスを中心に、AWS WAF（Web Application Firewall）、そしてオプションとして AWS Certificate Manager（ACM）について学習します。

これまで構築してきた簡易ウェブアプリケーション「シンプルブログ」の本体が完成となる節目の日です。データベースを用いたウェブアプリケーション開発における、コアな AWS サービスについてすべて網羅することができます。

## 学習目標

- CDN と Amazon CloudFront の基本概念を理解する
- CloudFront を使用してコンテンツをキャッシュする
- AWS WAF を設定してセキュリティを強化する
- Route 53 と ACM を連携して HTTPS 化する（オプション）

## 前提条件

- Day8 までの構成が完了していること
- ALB（Application Load Balancer）が設定済みであること
- S3 バケット（画像用）が設定済みであること
- Route 53 でドメインを取得していること（オプション作業用）

## 今日の構成変更

これまでの構成では、ALB の DNS 名を直接ブラウザで叩いてシンプルブログにアクセスしていました。
Day9 では、CloudFront 経由で ALB に接続するように変更します。

```
[ユーザー] → [CloudFront] → [ALB] → [EC2] → [RDS]
                ↓
             [S3（画像）]
```

## 1. CDN と Amazon CloudFront について

### CDN とは

CDN（コンテンツデリバリーネットワーク）は、ウェブサーバーなどのリソースの前端に配置し、コンテンツをキャッシュすることで以下の効果を得られます：

- ウェブサーバーの負担軽減
- ユーザーへのレスポンス向上
- ユーザー体験の向上

### Amazon CloudFront の特徴

1. **フルマネージド型サービス**

   - スペックやスケーラビリティは AWS 側で管理
   - 利用者は使用に専念できる

2. **グローバルなインフラ**

   - 世界各地にエッジロケーションを配置
   - ユーザーに最も近いエッジロケーションからレスポンスを提供

3. **AWS サービスとの連携**
   - AWS WAF、ACM などとのシームレスな連携が可能

### キャッシュの仕組み

- **初回アクセス時**: CloudFront にキャッシュがない場合、オリジンサーバーからコンテンツを取得してキャッシュ
- **TTL（Time To Live）**: キャッシュの保持期間を指定（例：60 秒）
- **キャッシュヒット**: TTL 内であれば CloudFront からキャッシュを返却
- **キャッシュミス**: TTL 期限切れの場合、オリジンサーバーから再取得

## 2. CloudFront ディストリビューションの作成

### 2-1. 基本設定

1. AWS マネジメントコンソールで CloudFront サービスにアクセス
2. 「ディストリビューションを作成」をクリック

### 2-2. オリジンの設定

1. **オリジンドメイン**

   - 検索ボックスをクリックして ELB を選択
   - `udemy-aws-14days-alb`を選択

2. **プロトコル**
   - 「HTTP のみ」を選択（HTTPS 未対応のため）

### 2-3. キャッシュ設定

1. **キャッシュポリシー**

   - カスタムで作成済みのポリシーを選択
   - スクロールして「カスタム」セクションから選択

2. **WAF 設定**

   - 一旦「セキュリティ保護を有効にしない」を選択

3. 「ディストリビューションを作成」をクリック

### 2-4. デプロイ完了の確認

- 最終変更日が「デプロイ中」から日時に変わるまで待機（数分程度）
- デプロイ完了後、ディストリビューションドメイン名をコピー

## 3. 動作確認とブラウザツールの使用

### 3-1. 基本アクセス確認

1. 新しいタブでディストリビューションドメイン名にアクセス
2. シンプルブログが正常に表示されることを確認

### 3-2. デベロッパーツールによる確認

1. **デベロッパーツールの起動**

   - Chrome: 表示 → 開発管理 → デベロッパーツール
   - ショートカットキー使用も可

2. **ネットワークタブの確認**

   - ネットワークタブをクリック
   - スーパーリロード（Ctrl+Shift+R）を実行

3. **キャッシュ状況の確認**
   - `X-Cache`ヘッダーを確認
   - `Miss from cloudfront`: 初回アクセス（キャッシュなし）
   - `Hit from cloudfront`: キャッシュからの応答
   - `RefreshHit from cloudfront`: TTL 期限切れ後の再検証

## 4. S3 オリジンの追加と設定

### 4-1. S3 オリジンの追加

1. ディストリビューション設定画面で「オリジン」タブを選択
2. 「オリジンを作成」をクリック
3. **オリジンドメイン**: Web 画像用の S3 バケットを選択

### 4-2. オリジンアクセスコントロール（OAC）の設定

1. **オリジンアクセス**: 「オリジンアクセスコントロール設定」を選択
2. 「Create new OAC」をクリック
3. デフォルト名のまま「作成」をクリック
4. 表示されるポリシーをコピー

### 4-3. S3 バケットポリシーの更新

1. 「S3 バケットアクセス許可に移動」をクリック
2. S3 コンソールでアクセス許可タブを選択
3. バケットポリシーを編集
4. 既存のポリシーを削除し、コピーした OAC ポリシーを貼り付け
5. 「変更の保存」をクリック
6. CloudFront 画面に戻り「オリジンを作成」をクリック

## 5. ビヘイビア（動作）の設定

### 5-1. 画像用ビヘイビアの作成

1. 「ビヘイビア」タブを選択
2. 「ビヘイビアを作成」をクリック
3. **パスパターン**: `/images/*`を入力
4. **オリジン**: S3 バケット（画像用）を選択
5. **キャッシュポリシー**: 作成済みのイメージキャッシュポリシーを選択
6. 「ビヘイビアを作成」をクリック

### 5-2. デフォルトビヘイビアの修正

1. デフォルト（\*）のビヘイビアを選択
2. 「編集」をクリック
3. **キャッシュポリシー**: 「CachingDisabled」を選択（キャッシュしない設定）
4. 「変更を保存」をクリック

### 5-3. デプロイ完了の待機

- 設定変更後、再度デプロイが実行される
- 最終変更日が日時に変わるまで待機

## 6. キャッシュ動作の確認

### 6-1. 画像キャッシュの確認

1. ディストリビューションドメイン名 + `/images/image_1_s3.png`にアクセス
2. デベロッパーツールで以下を確認：
   - 初回: `Miss from cloudfront`
   - 15 秒以内の再アクセス: `Hit from cloudfront`
   - 15 秒経過後: `RefreshHit from cloudfront`

### 6-2. メインページの確認

1. ディストリビューションドメイン名のルートにアクセス
2. 常に`Miss from cloudfront`になることを確認（キャッシュ無効設定のため）

## 7. データベースレコードの更新

### 7-1. EC2 への接続

```bash
ssh -i udemy.pem ec2-user@[EC2のパブリックIP]
```

### 7-2. MySQL への接続

```bash
mysql -h [RDSエンドポイント] -u admin -p simple_blog
```

### 7-3. 画像パスの更新

```sql
-- 既存レコードの削除
DELETE FROM posts;

-- 新しいレコードの挿入（CloudFrontドメインを使用）
INSERT INTO posts (title, body, image_path) VALUES
('投稿1', '本文1', 'https://[ディストリビューションドメイン]/images/image_1_s3.png'),
('投稿2', '本文2', 'https://[ディストリビューションドメイン]/images/image_2_s3.png'),
('投稿3', '本文3', 'https://[ディストリビューションドメイン]/images/image_3_s3.png'),
('投稿4', '本文4', 'https://[ディストリビューションドメイン]/images/image_4_s3.png');
```

### 7-4. 更新結果の確認

1. ブラウザでシンプルブログにアクセス
2. 画像が正常に表示されることを確認
3. デベロッパーツールで画像がキャッシュされていることを確認

## 8. Route 53 と ACM の連携（オプション）

### 8-1. SSL 証明書の作成

1. CloudFront ディストリビューション設定で「編集」をクリック
2. **代替ドメイン名**: Route 53 で取得したドメインを入力
3. **カスタム SSL 証明書**: 「証明書をリクエスト」をクリック
4. ACM コンソールで：
   - 「パブリック証明書をリクエスト」を選択
   - ドメイン名を入力
   - 「リクエスト」をクリック
5. 「Route 53 でレコード作成」をクリック
6. レコード作成を承認
7. 証明書のステータスが「発行済み」になるまで待機

### 8-2. CloudFront ディストリビューションの更新

1. CloudFront 設定画面に戻る
2. 作成した SSL 証明書を選択
3. 「変更を保存」をクリック
4. デプロイ完了まで待機

### 8-3. Route 53 A レコードの更新

1. Route 53 コンソールでホストゾーンを選択
2. A レコードを編集
3. **ルーティング先**: 「CloudFront ディストリビューションへのエイリアス」を選択
4. 作成したディストリビューションを選択
5. 「保存」をクリック

### 8-4. HTTPS リダイレクトの設定

1. CloudFront ディストリビューションの「ビヘイビア」タブ
2. 各ビヘイビア（画像用とデフォルト）を編集
3. **ビューアプロトコルポリシー**: 「Redirect HTTP to HTTPS」を選択
4. 「変更を保存」をクリック

### 8-5. HTTPS 動作確認

1. HTTP でドメインにアクセス
2. 自動的に HTTPS にリダイレクトされることを確認
3. ブラウザのアドレスバーで「保護された通信」を確認

## 9. AWS WAF の設定

### 9-1. IP セットの作成

1. WAF コンソールで「IP sets」を選択
2. 「Create IP set」をクリック
3. **名前**: `udemy-aws-14days-ip-set`
4. **リージョン**: 「Global (CloudFront)」を選択
5. **IP アドレス**: CloudShell のパブリック IP アドレスを追加
6. 「Create IP set」をクリック

### 9-2. Web ACL の作成

1. 「Web ACLs」を選択
2. 「Create web ACL」をクリック
3. **名前**: `udemy-aws-14days-web-acl`
4. **リソースタイプ**: 「CloudFront distributions」を選択
5. **リソース**: 作成したディストリビューションを選択
6. 「Next」をクリック

### 9-3. ルールの追加

1. 「Add rules」をクリック
2. 「Add my own rules and rule groups」を選択
3. **ルールタイプ**: 「IP set」を選択
4. **ルール名**: `udemy-aws-14days-my-rule-ip-set`
5. **IP セット**: 作成した IP セットを選択
6. **アクション**: 「Block」（デフォルト）
7. 「Add rule」をクリック
8. 「Next」を複数回クリックして設定を完了
9. 「Create web ACL」をクリック

### 9-4. WAF 動作確認

1. **ブラウザからのアクセス**: 正常に表示されることを確認
2. **CloudShell からのアクセス**:
   ```bash
   curl https://[ディストリビューションドメイン]
   ```
   403 エラーが返されることを確認

### 9-5. マネージドルールの紹介（参考）

- WAF コンソールで「Managed rule groups」を確認
- AWS 提供の事前定義されたルール群を確認：
  - Core rule set（OWASP Top 10 対応）
  - Bot control
  - その他のセキュリティルール

## 10. CloudFront 運用時のポイント

### 10-1. キャッシュ TTL の設計

- **短すぎる場合**: キャッシュ効果が薄い（例：1 秒）
- **長すぎる場合**: コンテンツ更新が反映されない
- **推奨アプローチ**: ビジネス要件に合わせた設計
  - 頻繁に更新されないコンテンツ: 長めの TTL（例：300 秒）
  - リアルタイム性が重要: 短めの TTL またはアプリケーション側での工夫

### 10-2. 監視の重要性

- CloudWatch で CloudFront のメトリクスを監視
- エラー率、レスポンス時間、キャッシュヒット率等を確認
- アラートを設定して問題の早期発見

### 10-3. 定期的な設定見直し

- 利用者の使用パターンの変化に応じた最適化
- ポピュラーオブジェクトレポートの活用
- キャッシュヒット率の分析と改善

### 10-4. ポピュラーオブジェクトレポートの確認

1. CloudFront コンソールで「レポートと分析」を選択
2. 「人気オブジェクト」をクリック
3. オブジェクトごとのキャッシュヒット率を確認
4. ヒット率の低いオブジェクトの設定を見直し

## 11. リソースのクリーンアップ

### 11-1. WAF 設定の削除

1. CloudFront ディストリビューションの「セキュリティ」タブ
2. WAF 設定を「無効」に変更
3. Web ACL を削除
4. IP セットを削除

### 11-2. その他のリソース

- CloudFront ディストリビューション: 必要に応じて保持
- Route 53 設定: 必要に応じて保持
- SSL 証明書: 自動で管理されるため手動削除不要

## プラスアルファチャレンジ

### チャレンジ 1: CloudFront 設定項目の調査

今回触れなかった CloudFront の設定項目について調査してみましょう：

- Behavior 設定の詳細オプション
- オリジン設定の高度な機能
- セキュリティヘッダーの設定
- ログ設定と S3 への出力

### チャレンジ 2: AWS WAF マネージドルールの調査

今回使用しなかったマネージドルールについて調査してみましょう：

- Core rule set の詳細
- Bot control の機能
- 地域別ブロック機能
- レート制限機能

## まとめ

Day9 では以下を学習しました：

1. **CDN の基本概念と CloudFront の特徴**

   - キャッシュによる性能向上とサーバー負荷軽減
   - グローバルなエッジロケーション
   - AWS サービスとの連携

2. **CloudFront の実装**

   - ディストリビューションの作成
   - 複数オリジンの設定（ALB + S3）
   - ビヘイビアによるキャッシュ制御

3. **セキュリティ強化**

   - AWS WAF による Web アプリケーション保護
   - IP ベースのアクセス制御
   - マネージドルールの活用

4. **HTTPS 化（オプション）**
   - ACM による SSL 証明書管理
   - Route 53 との連携
   - HTTPS 自動リダイレクト

Day9 により、シンプルブログアプリケーションが完成し、本格的な Web アプリケーションとしての基盤が整いました。パフォーマンス、セキュリティ、可用性の全ての面で実用的なレベルに到達しています。

次回の Day10 では、監視とロギングについて学習していきます。

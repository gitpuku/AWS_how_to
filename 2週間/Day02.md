# Day02: AWS の EC2 を使って仮想サーバーを立てる

## 事前準備と注意事項

### 1. ログイン環境の確認

- **IAM ユーザー**でマネジメントコンソールにログイン（ルートユーザーではない）
- IAM ユーザーのログイン方法は**Day01**を参照
- IAM ユーザーには**Administrator アクセスポリシー**が付与されていることを確認

### 2. 環境設定

- **リージョン**: 東京リージョンに設定
- **言語**: 日本語表記を推奨（英語でも可）

### 3. コマンド操作について

- 短いコマンドは手打ち
- 長いコマンドは補足資料からコピー&ペースト
- **補足資料の入手方法**:
  - Udemy の動画右側「リソース」ボタンからダウンロード
  - GitHub「udemy-aws-14days」リポジトリからも取得可能
- コマンドは動画に合わせて使用する/しないを選択

---

## EC2 インスタンス起動手順

### Step 1: EC2 サービスへのアクセス

1. AWS マネジメントコンソール左上の検索窓に「ec2」と入力
2. 検索結果から「EC2」（シンプルな表記）をクリック
3. Amazon EC2 のメイン画面に移動

### Step 2: インスタンスの起動開始

1. 「**インスタンスを起動**」ボタンをクリック

### Step 3: インスタンスの基本設定

#### 3.1 インスタンス名

- 名前: `Sample EC2`

#### 3.2 AMI（Amazon Machine Image）の選択

- **デフォルト**: `Amazon Linux 2023 AMI` をそのまま使用
- 変更不要

**AMI の参考情報**:

- **AWS Marketplace AMI**: 企業・団体が提供する AMI も選択可能
- **自分の AMI**: 自分で作成したカスタム AMI がある場合はここに表示

#### 3.3 インスタンスタイプの選択

- **推奨**: `t2.micro` を選択
- **理由**: 無料利用枠の対象
- **メモリ**: 1GB
- **用途**: テスト・検証・ハンズオン

**インスタンスタイプの補足**:

- t2 シリーズ: 検証・テスト用
- t3 シリーズ: t2 より新しいが、無料枠を考慮して t2.micro を推奨
- 本番環境: メモリ要件に応じてより大きなインスタンスタイプを検討

---

## セキュリティ設定

### Step 4: キーペアの作成

1. 「**新しいキーペアの作成**」をクリック
2. キーペア名: `udemy-aws-14days`
3. 「**キーペアを作成**」をクリック
4. `.pem`ファイルがダウンロードされるので保存

### Step 5: ネットワーク設定

1. **VPC とサブネット**: デフォルト設定をそのまま使用
2. **セキュリティグループ**: 新規作成を選択
3. **重要**: 最初は「SSH トラフィックを許可」のチェックを**外す**（実験のため）

### Step 6: ストレージ設定

- **容量**: 8GB（デフォルト）をそのまま使用

### Step 7: 高度な詳細（オプション）

- **終了保護**: 誤操作防止のためのオプション（今回は設定しない）
- **ユーザーデータ**: インスタンス起動時に自動実行するコマンドを設定可能（今回は使用しない）

### Step 8: インスタンスの起動

1. 「**インスタンスを起動**」をクリック
2. 「**すべてのインスタンスを表示**」をクリック
3. ステータスチェックが「2/2」になるまで待機

---

## AWS CloudShell を使った接続

### Step 9: CloudShell のセットアップ

1. AWS マネジメントコンソールで「cloudshell」と検索
2. 青いシェルマークのサービスをクリック
3. 歯車マークからフォントサイズを「Large」に変更（推奨）

**CloudShell の利点**:

- ブラウザ上で動作するシェル環境
- Windows/Mac 等の環境差分を吸収
- **注意**: 120 日間未使用でデータが削除される

### Step 10: キーファイルのアップロード

1. CloudShell で「**ファイルのアップロード**」をクリック
2. ダウンロードした`udemy-aws-14days.pem`をアップロード

### Step 11: 最初の SSH 接続（失敗の実験）

```bash
ssh -i udemy-aws-14days.pem ec2-user@[パブリックIPアドレス]
```

- **結果**: 接続失敗（セキュリティグループで SSH を許可していないため）

---

## セキュリティグループの設定

### Step 12: セキュリティグループの修正

1. EC2 インスタンス画面でインスタンスを選択
2. 「**セキュリティ**」タブを開く
3. セキュリティグループのリンクをクリック
4. 「**インバウンドルールを編集**」をクリック

### Step 13: SSH ルールの追加

1. 「**ルールを追加**」をクリック
2. **タイプ**: `SSH` を選択
3. **ソース**: `Anywhere IPv4`（本番環境では適切な IP アドレスに制限）
4. 「**ルールを保存**」をクリック

**セキュリティのベストプラクティス**:

- 本番環境では接続元 IP アドレスを制限
- CloudShell の IP アドレス確認方法: `curl http://checkip.amazonaws.com`

---

## SSH 接続と Apache のインストール

### Step 14: SSH 接続の成功

```bash
# キーファイルの権限変更
chmod 400 udemy-aws-14days.pem

# SSH接続
ssh -i udemy-aws-14days.pem ec2-user@[パブリックIPアドレス]
```

### Step 15: Apache のインストールと設定

```bash
# パッケージマネージャーの更新
sudo dnf update -y

# Apacheがインストールされていないことを確認
dnf list installed | grep httpd

# Apacheのインストール
sudo dnf install httpd

# インストール確認
dnf list installed | grep httpd

# Apacheのステータス確認
systemctl status httpd

# Apacheの起動
sudo systemctl start httpd

# 起動確認
systemctl status httpd
```

### Step 16: HTTP アクセスの設定

1. セキュリティグループの設定に戻る
2. 「**ルールを追加**」をクリック
3. **タイプ**: `HTTP` を選択
4. **ソース**: `Anywhere IPv4`
5. 「**ルールを保存**」をクリック

### Step 17: Web サーバーの動作確認

- ブラウザで`http://[パブリックIPアドレス]`にアクセス
- Apache のテストページが表示されることを確認

---

## AMI（Amazon Machine Image）の作成と活用

### Step 18: インスタンスの停止

1. EC2 インスタンスを選択
2. 「**インスタンスの状態**」→「**インスタンスを停止**」

### Step 19: AMI の作成

1. 停止したインスタンスを選択
2. 「**アクション**」→「**イメージとテンプレート**」→「**イメージを作成**」
3. イメージ名: `サンプルEC2-AMI`
4. 「**イメージを作成**」をクリック

### Step 20: AMI からの新しいインスタンス起動

1. AMI ページで作成した AMI を選択
2. 「**AMI からインスタンスを起動**」をクリック
3. インスタンス名: `サンプルEC2-from-AMI`
4. キーペア: `udemy-aws-14days`
5. セキュリティグループ: 既存のものを選択
6. インスタンスを起動

### Step 21: AMI から作成したインスタンスの確認

```bash
# SSH接続
ssh -i udemy-aws-14days.pem ec2-user@[新しいパブリックIPアドレス]

# Apacheがインストール済みであることを確認
dnf list installed | grep httpd

# Apacheの起動（AMIには設定が保存されているが、自動起動は設定されていない）
sudo systemctl start httpd

# ブラウザでアクセス確認
```

---

## Elastic IP アドレスの設定

### Step 22: Elastic IP の割り当て

1. EC2 左メニューから「**Elastic IP**」を選択
2. 「**Elastic IP アドレスを割り当てる**」をクリック
3. デフォルト設定で「**割り当てる**」をクリック

### Step 23: Elastic IP の関連付け

1. 作成した Elastic IP を選択
2. 「**アクション**」→「**Elastic IP アドレスを関連付ける**」
3. 対象インスタンスを選択
4. 「**関連付ける**」をクリック

### Step 24: IP アドレス固定の確認

- インスタンスを停止・開始しても IP アドレスが変わらないことを確認

---

## リソースのクリーンアップ

### Step 25: Elastic IP の削除

1. Elastic IP の関連付けを解除
2. Elastic IP アドレスを開放

### Step 26: インスタンスの削除

1. **終了保護の実験**:

   - インスタンス設定で終了保護を有効化
   - 削除を試行（失敗することを確認）
   - 終了保護を無効化してから削除

2. 両方のインスタンスを「**インスタンスを終了**」で削除

### Step 27: その他リソースの削除

- AMI の登録解除
- スナップショットの削除
- セキュリティグループの削除

---

## 重要なポイントとベストプラクティス

### セキュリティ

- セキュリティグループは最小権限の原則に従う
- SSH アクセスは必要な接続元 IP のみに制限
- キーペアファイルは適切な権限設定（400）で管理

### 運用

- 不要なリソースは速やかに削除してコストを抑制
- 終了保護機能で重要なインスタンスの誤削除を防止
- AMI を活用して標準化されたインスタンスを効率的に作成

### トラブルシューティング

- ログとエラーメッセージを注意深く読む
- セキュリティグループの設定を確認
- ネットワーク接続の問題を段階的に切り分け

---

## 次のステップ

- Day03: VPC とネットワーク設定
- 他の EC2 接続方法（Session Manager 等）の学習
- セキュリティ強化の実装

**注意**: この手順書は学習・ハンズオン目的で作成されています。本番環境では追加のセキュリティ設定と運用設計が必要です。

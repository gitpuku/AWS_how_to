# Day 06: Elastic Load Balancing(ELB)を用いて Web レイヤの可用性を高める

## 概要

Day6 では、Elastic Load Balancing（ELB）を用いて Web レイヤーの可用性を高める方法を学習します。クラウドらしい機能である ALB（Application Load Balancer）とオートスケーリングを実際に構築し、単一障害点（SPOF）を排除した高可用性なシステムを構築します。

## 学習目標

- ELB の基本概念と種類を理解する
- Application Load Balancer（ALB）を構築する
- オートスケーリング機能を設定・運用する
- 単一障害点（SPOF）の概念を理解し、設計に活かす

## 前提条件

- Day5 までの構成が完了していること
- Web サーバー EC2 インスタンス（Web-1A）が起動していること
- RDS はシングル AZ 構成に戻されていること

---

## 1. 理論編：設計における可用性の考え方

### 1.1 SPOF（Single Point of Failure）とは

- **定義**: システム全体が停止してしまう単一障害点
- **重要性**: 設計時に必ず意識すべきポイント
- **対策**: 冗長化によって SPOF を排除する

### 1.2 AWS マネージドサービスの可用性

- **Internet Gateway**: AWS 側で自動的に冗長化済み
- **ELB**: 高可用性のための設計が施されている
- **RDS**: Multi-AZ デプロイメント機能でユーザーが選択可能

---

## 2. ELB の基本知識

### 2.1 ELB の種類

1. **Application Load Balancer（ALB）** ← 今回使用
   - L7（アプリケーション層）での負荷分散
   - HTTP/HTTPS 通信に対応
2. Network Load Balancer（NLB）
3. Gateway Load Balancer（GWLB）
4. Classic Load Balancer（CLB）※非推奨

### 2.2 ALB の主要機能

#### 負荷分散機能

- 複数のターゲット間でリクエストを均等に分散
- 各ターゲットの負荷状況を監視

#### ヘルスチェック機能

- ターゲットの健全性を定期的に監視
- 異常なターゲットを自動的に切り離し
- 復旧後は自動的に再接続

**主要設定項目**:

- ヘルスチェック間隔: 30 秒（推奨）
- 失敗閾値: 2 回連続失敗で NG
- 成功閾値: 5 回連続成功で OK

#### オートスケーリング機能

- 条件に基づいて EC2 インスタンス数を自動増減
- **スケールアウト**: サーバー台数を増やす
- **スケールイン**: サーバー台数を減らす
- コスト最適化と性能のバランスを自動調整

---

## 3. 事前準備

### 3.1 EC2 インスタンスの停止

1. EC2 コンソールで Web-1A インスタンスを選択
2. 「インスタンスの状態」→「インスタンスを停止」

### 3.2 AMI 取得

1. 停止した Web-1A を選択
2. 「アクション」→「イメージとテンプレート」→「イメージを作成」
3. イメージ名: `Web-AMI`
4. 「イメージを作成」をクリック

### 3.3 2 台目の EC2 インスタンス作成

1. 作成した Web-AMI を選択
2. 「AMI からインスタンスを起動」をクリック
3. **設定項目**:
   - 名前: `Web-1C`
   - キーペア: `udemy-aws-14days`
   - VPC: `udemy-aws-14days-vpc`
   - サブネット: `Public-1C`
   - セキュリティグループ: `WebSG`
   - プライマリ IP: `10.0.2.10`

### 3.4 両インスタンスの起動と識別設定

1. Web-1A と Web-1C の両方を起動
2. Cloud Shell から各インスタンスに SSH 接続
3. タイトルを識別できるよう修正:

```bash
# Web-1Aの場合
sudo vim /var/www/html/index.php
# <h2>シンプルブログ</h2> を <h2>シンプルブログ-1A</h2> に変更

# Web-1Cの場合
sudo vim /var/www/html/index.php
# <h2>シンプルブログ</h2> を <h2>シンプルブログ-1C</h2> に変更
```

---

## 4. ターゲットグループの作成

### 4.1 ターゲットグループ作成

1. EC2 コンソール → 「ロードバランシング」→「ターゲットグループ」
2. 「ターゲットグループの作成」をクリック

### 4.2 基本設定

- **ターゲットタイプ**: インスタンス
- **ターゲットグループ名**: `udemy-aws-14days-tg`
- **プロトコル**: HTTP
- **ポート**: 80
- **VPC**: `udemy-aws-14days-vpc`

### 4.3 ヘルスチェック詳細設定

- **間隔**: 10 秒（ハンズオン用に短縮）
- **失敗閾値**: 2 回
- **成功閾値**: 2 回（ハンズオン用に短縮）

### 4.4 ターゲット登録

1. Web-1A と Web-1C の両方を選択
2. 「保留中として以下を含める」をクリック
3. 「ターゲットグループの作成」をクリック

---

## 5. セキュリティグループの設定

### 5.1 ALB 用セキュリティグループ作成

1. EC2 コンソール → 「セキュリティグループ」
2. 「セキュリティグループを作成」をクリック

**設定内容**:

- **名前**: `ALB-SG`
- **説明**: ALB-SG
- **VPC**: `udemy-aws-14days-vpc`
- **インバウンドルール**:
  - タイプ: HTTP
  - ソース: 0.0.0.0/0

### 5.2 WebSG の修正

1. WebSG を選択
2. 「インバウンドルールを編集」
3. HTTP ルールを削除
4. 新しい HTTP ルールを追加:
   - タイプ: HTTP
   - ソース: ALB-SG

---

## 6. Application Load Balancer（ALB）の作成

### 6.1 ALB 作成開始

1. EC2 コンソール → 「ロードバランサー」
2. 「ロードバランサーの作成」をクリック
3. 「Application Load Balancer」の「作成」を選択

### 6.2 基本設定

- **名前**: `udemy-aws-14days-alb`
- **スキーム**: インターネット向け
- **IP アドレスタイプ**: IPv4

### 6.3 ネットワークマッピング

- **VPC**: `udemy-aws-14days-vpc`
- **アベイラビリティゾーン**:
  - us-east-1a: `Public-1A`
  - us-east-1c: `Public-1C`

### 6.4 セキュリティグループ

- デフォルトを削除
- `ALB-SG`のみを選択

### 6.5 リスナーとルーティング

- **プロトコル**: HTTP
- **ポート**: 80
- **ターゲットグループ**: `udemy-aws-14days-tg`

### 6.6 ALB 作成完了

「ロードバランサーの作成」をクリック

---

## 7. 負荷分散動作の確認

### 7.1 ALB の DNS 名確認

1. 作成された ALB の詳細画面を開く
2. DNS 名をコピー

### 7.2 負荷分散テスト

1. ブラウザで DNS 名にアクセス
2. リロードを繰り返し実行
3. 「シンプルブログ-1A」と「シンプルブログ-1C」が交互に表示されることを確認

### 7.3 ヘルスチェック確認

1. ターゲットグループの詳細を確認
2. 両方のターゲットが「正常」になっていることを確認

---

## 8. 障害時の動作確認

### 8.1 疑似障害の発生

1. Cloud Shell から Web-1C に SSH 接続
2. Apache を停止:

```bash
sudo systemctl stop httpd
```

### 8.2 動作確認

1. ALB の DNS 名を繰り返しリロード
2. 最初の 10-20 秒間: 502 エラーが間欠的に発生
3. その後: Web-1A のみが表示される

### 8.3 ヘルスチェック状態確認

- ターゲットグループで「異常: 1」「正常: 1」を確認

### 8.4 復旧確認

1. Web-1C で Apache を再起動:

```bash
sudo systemctl start httpd
```

2. 10-20 秒後に負荷分散が再開されることを確認

---

## 9. オートスケーリングの設定

### 9.1 起動テンプレートの作成

1. EC2 コンソール → 「起動テンプレート」
2. 「起動テンプレートを作成」をクリック

**設定内容**:

- **名前**: `udemy-aws-14days-web-lt`
- **ガイダンス**: オートスケーリング用にチェック
- **AMI**: Web-AMI
- **インスタンスタイプ**: t2.micro
- **キーペア**: udemy-aws-14days
- **セキュリティグループ**: WebSG

### 9.2 オートスケーリンググループの作成

1. EC2 コンソール → 「オートスケーリンググループ」
2. 「オートスケーリンググループを作成」をクリック

**基本設定**:

- **名前**: `udemy-aws-14days-asg`
- **起動テンプレート**: `udemy-aws-14days-web-lt`

**ネットワーク設定**:

- **VPC**: `udemy-aws-14days-vpc`
- **サブネット**: Public-1A、Public-1C

**ロードバランサー設定**:

- 既存のロードバランサーにアタッチ
- **ターゲットグループ**: `udemy-aws-14days-tg`
- ELB ヘルスチェックを有効化

**グループサイズ設定**:

- **希望するキャパシティ**: 2
- **最小キャパシティ**: 2
- **最大キャパシティ**: 4

**スケーリングポリシー**:

- **タイプ**: ターゲット追跡スケーリング
- **メトリクス**: 平均 CPU 使用率
- **目標値**: 25%（ハンズオン用）
- **ウォームアップ**: 300 秒

**タグ設定**:

- **キー**: Name
- **値**: Web-AutoScaling

---

## 10. オートスケーリングの動作確認

### 10.1 事前準備

1. 手動作成した EC2 インスタンスをターゲットグループから削除
2. ドレイン時間を 10 秒に変更（設定変更）

### 10.2 負荷テスト（スケールアウト）

1. オートスケーリングで起動したインスタンスに SSH 接続
2. CPU 負荷をかける:

```bash
yes > /dev/null &
yes > /dev/null &
yes > /dev/null &
```

### 10.3 CloudWatch アラーム確認

1. オートスケーリンググループ → モニタリング
2. CloudWatch メトリクスで CPU 使用率を確認
3. アラーム状態（赤）になることを確認

### 10.4 スケールアウト確認

1. EC2 インスタンス一覧で台数増加を確認
2. 最大 4 台まで増加することを確認
3. ターゲットグループで 4 台が正常になることを確認

### 10.5 負荷テスト停止（スケールイン）

1. 各インスタンスで負荷プロセスを停止:

```bash
# プロセス確認
top
# プロセス終了（PIDは環境により異なる）
kill 2888 2889 2890
```

### 10.6 スケールイン確認

1. 15 分程度でアラーム解除
2. インスタンス数が 2 台まで減少
3. 希望するキャパシティが 2 に戻ることを確認

---

## 11. リソースの整理

### 11.1 オートスケーリング関連削除

1. オートスケーリンググループを削除
   - 「delete」と入力して削除
2. 起動テンプレートを削除

### 11.2 手動インスタンスの復活

1. Web-1A をターゲットグループに再登録
2. Web-1C を停止状態で保持

### 11.3 最終構成確認

- ALB → Web-1A（1 台）の構成
- Web-1C は停止状態で保持

---

## 12. 設計ポイント

### 12.1 Multi-AZ 配置

- 複数の AZ にリソースを配置
- AZ 障害に対する耐性向上
- デメリットはほとんどなし

### 12.2 ステートレス設計

- **原則**: アプリケーションは状態を持たない
- **ファイル**: S3 に保存
- **セッション**: 外部ストレージに保存
- **インスタンス**: 使い捨て可能な設計

### 12.3 オートスケーリング利用時の注意点

- インスタンスが自動的に削除される
- ソースコードは外部管理
- 自動デプロイの仕組みが必要

---

## まとめ

Day6 では以下を学習しました：

1. **SPOF 概念**: 単一障害点を排除する設計思想
2. **ELB 機能**: 負荷分散、ヘルスチェック、オートスケーリング
3. **ALB 構築**: Application Load Balancer の実装
4. **オートスケーリング**: 自動的なスケールアウト/イン
5. **設計原則**: Multi-AZ 配置とステートレス設計

これらの知識により、高可用性で拡張性のある Web システムを構築できるようになりました。

---

## プラスアルファチャレンジ

### チャレンジ 1: ELB とオートスケーリングの追加調査

- Network Load Balancer（NLB）の特徴
- Gateway Load Balancer（GWLB）の用途
- ステップスケーリング、スケジュールスケーリングの違い

### チャレンジ 2: プライベートサブネット配置

- EC2 インスタンスをプライベートサブネットに配置
- ALB 経由での HTTP 通信確認
- SSH 接続とインターネットアクセスの制限確認
- NAT Gateway とセッションマネージャーの活用検討

---

**次回**: Day7 では、さらなる AWS サービスの活用を学習していきます。

# Day11：実験を通してAWS IAMの理解を深める

## 概要
AWS IAM（Identity and Access Management）は、AWSアカウントにおけるIDとAWSサービスリソースへのアクセスを安全に管理するサービスです。本日は、IAMの4つの主要構成要素について実験を通して理解を深めます。

### 学習目標
- IAMポリシー、IAMユーザー、IAMグループ、IAMロールの役割を理解する
- 実際の操作を通して各構成要素の動作を確認する
- IAMのベストプラクティスを学ぶ

## AWS IAMの基本概念

### IAMの4つの構成要素
1. **IAMポリシー**: 何ができるか、何ができないかを記したもの
2. **IAMユーザー**: AWSアカウントにアクセスする個人用のID
3. **IAMグループ**: 複数のユーザーをまとめて管理する仕組み
4. **IAMロール**: AWSリソースに権限を与える仕組み

## 実習1: IAMポリシーの作成

### アプリユーザー用ポリシーの作成

1. AWSマネジメントコンソールでIAMサービスにアクセス
2. 左メニューから「ポリシー」を選択
3. 「ポリシーの作成」をクリック

#### EC2の権限設定
1. サービスで「EC2」を選択
2. アクションで「リスト」から「Describe*」を選択
3. 「読み取り」から「Get*」を選択
4. アクションフィルタリングに「Start」と入力し、「StartInstances」を選択
5. 同様に「Stop」で検索し、「StopInstances」を選択
6. リソースは「すべて」を選択

#### RDSの権限設定
1. 「許可をさらに追加」をクリック
2. サービスで「RDS」を選択
3. アクションで「リスト」から「Describe*」を選択
4. リソースは「すべて」を選択

#### ポリシーの完成
1. 「次へ」をクリック
2. ポリシー名: `udemy-aws-forty-days-app-user-policy`
3. 「作成」をクリック

### インフラユーザー用ポリシーの作成

1. 「ポリシーの作成」をクリック
2. サービスで「EC2」を選択し、「すべてのEC2アクション」を選択
3. リソースは「すべて」を選択
4. 「許可をさらに追加」で「RDS」を追加し、すべてのアクションを選択
5. 「許可をさらに追加」で「IAM」を追加し、すべてのアクションを選択
6. ポリシー名: `udemy-aws-forty-days-infra-user-policy`
7. 「作成」をクリック

## 実習2: IAMユーザーの作成

### 山田さん（アプリ開発者）の作成

1. IAMメニューから「ユーザー」を選択
2. 「ユーザーの作成」をクリック
3. ユーザー名: `yamada`
4. 「AWSマネジメントコンソールへのユーザーアクセスを提供する」にチェック
5. 「IAMユーザーを作成します」を選択
6. カスタムパスワードを設定
7. 「ユーザーは次回のサイン時に新しいパスワードを作成する必要があります」のチェックを外す
8. 「次へ」をクリック

#### 許可の設定
1. 「ポリシーを直接アタッチ」を選択
2. 絞り込みタイプで「カスタマー管理」を選択
3. `udemy-aws-forty-days-app-user-policy`にチェック
4. 「次へ」→「ユーザーの作成」

### 田中さん（インフラ担当）の作成

1. 同様の手順でユーザー名: `tanaka`を作成
2. 許可設定で`udemy-aws-forty-days-infra-user-policy`を選択

## 実習3: ユーザー権限の確認実験

### 山田さんでのログイン実験

1. IAMユーザー用のサインURLをコピー
2. シークレットモードのブラウザで山田さんとしてログイン
3. リージョンを東京に変更

#### 権限確認
1. EC2サービスにアクセス
2. インスタンス一覧が表示されることを確認
3. バッチサーバーの停止が可能であることを確認
4. 新しいインスタンス作成を試行→失敗することを確認

### 田中さんでのログイン実験

1. 山田さんをサインアウト
2. 田中さんでログイン
3. EC2インスタンスの開始が可能であることを確認
4. 新しいインスタンス作成が可能であることを確認
5. インスタンスの削除が可能であることを確認

## 実習4: IAMグループの作成と管理

### ユーザーからポリシーを削除

1. IAMユーザーメニューで山田さんを選択
2. 添付されているポリシーを削除
3. 田中さんも同様にポリシーを削除

### 権限削除後の確認
1. 山田さんでログイン
2. EC2インスタンス一覧にアクセス→失敗することを確認

### IAMグループの作成

#### アプリユーザーグループ
1. IAMメニューから「ユーザーグループ」を選択
2. 「グループを作成」をクリック
3. グループ名: `app-user-group`
4. 山田さんをグループに追加
5. 絞り込みタイプで「カスタマー管理」を選択
6. `udemy-aws-forty-days-app-user-policy`を選択
7. 「グループを作成」

#### インフラユーザーグループ
1. グループ名: `infra-user-group`
2. ポリシー設定: `udemy-aws-forty-days-infra-user-policy`
3. 「グループを作成」
4. 作成後、田中さんをグループに追加

### グループ権限の確認
1. 山田さんで再ログイン
2. EC2インスタンス一覧が再び表示されることを確認

## 実習5: IAMロールの作成と設定

### バッチシステム用ポリシーの作成

1. 「ポリシーの作成」をクリック
2. サービスで「S3」を選択
3. 「すべてのS3アクション」を選択
4. リソースは「すべて」を選択
5. ポリシー名: `udemy-aws-forty-days-batch-system-policy`

### IAMロールの作成

1. IAMメニューから「ロール」を選択
2. 「ロールを作成」をクリック
3. 信頼されたエンティティタイプ: 「AWSサービス」
4. サービス: 「EC2」を選択
5. 「次へ」をクリック
6. カスタマー管理から`udemy-aws-forty-days-batch-system-policy`を選択
7. ロール名: `udemy-aws-forty-days-batch-system-role`
8. 「ロールを作成」

### EC2インスタンスにロールを適用

1. EC2サービスに移動
2. バッチサーバーインスタンスを選択
3. 「アクション」→「セキュリティ」→「IAMロールを変更」
4. 作成したバッチシステムロールを選択
5. 「IAMロールの更新」

### ロール動作の確認

1. CloudShellでバッチサーバーにSSH接続
2. `python3 get_post_from_s3.py`を実行
3. S3からファイルが正常にダウンロードされることを確認

## IAMベストプラクティス

### 5つの基本原則

1. **利用者ごとにIAMユーザーを作成**
   - ユーザーの使い回しは絶対に禁止
   - 監査ログで操作者を特定できるようにする

2. **ジョブロール（役割）に応じたIAMグループを作成**
   - 個別ユーザーへの直接ポリシー割り当てを避ける
   - 設定ミスのリスクを軽減

3. **権限は必要最小限に**
   - 不要な権限は付与しない
   - セキュリティリスクを最小化

4. **定期的な棚卸し**
   - 退職者・異動者のIAMユーザーは速やかに削除
   - アクセス権限の定期見直し

5. **IAMロールの積極的な活用**
   - アクセスキーの漏洩リスクを回避
   - より安全な権限管理を実現

## クリーンアップ

### 不要なリソースの削除

1. **IAMユーザーの削除**
   - 田中さんと山田さんを選択して削除
   - 作業用ユーザーは残す

2. **IAMグループの削除**
   - 作成した2つのグループを削除

3. **IAMポリシーの削除**
   - カスタマー管理から作成したポリシーを削除
   - アプリユーザーポリシーとインフラユーザーポリシー

注意: IAMロールとバッチシステムポリシーは後の実習で使用するため削除しない

## まとめ

本日の実習を通して、AWS IAMの基本的な仕組みと各構成要素の役割を理解しました。IAMは見た目は地味ですが、AWSを安全に使用するための重要な基盤サービスです。

### 学習のポイント
- IAMポリシーで権限を定義
- IAMユーザーで個人を識別
- IAMグループで効率的な権限管理
- IAMロールでAWSリソースに権限付与

### 次のステップ
今回学んだ基本概念を基に、より複雑な権限設計や、他のAWSサービスとの連携について学習を進めていきましょう。

## プラスアルファチャレンジ

1. **追加サービスの権限設定**
   - これまでのハンズオンで使用したCloudFrontやRoute 53などの権限をポリシーに追加

2. **Well-Architected Frameworkの学習**
   - セキュリティの柱のアイデンティティ・アクセス管理セクションを確認
   - 今回扱えなかった考え方や観点を学習
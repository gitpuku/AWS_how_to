# Day5: リレーショナル DB のマネージドサービス Amazon RDS を利用する

## 🎯 概要

Day5 では、Amazon RDS（Relational Database Service）を使ってリレーショナルデータベースのマネージドサービスを活用します。これまで EC2 インスタンス上に MySQL を直接インストールしていましたが、マネージドサービスを使うことで運用負荷を大幅に削減できます。

## 📋 目標

- データベースのマネージドサービスの概念を理解する
- Amazon RDS の基本機能を習得する
- Multi-AZ 配置による高可用性構成を構築する
- スナップショット機能による バックアップ・リストアを体験する
- フェイルオーバー機能を実際に動作させる

## 🏗️ アーキテクチャの変更

現在の構成を Day4 の EC2 上の MySQL から、RDS を利用した構成に変更します：

**変更前：**

- Web Server (EC2) → DB Server (EC2 上の MySQL)

**変更後：**

- Web Server (EC2) → Amazon RDS (Multi-AZ 構成)

## 📚 マネージドサービスとは

### オンプレミスでの作業内容

データベースサーバーを利用するために必要な作業：

- ハードウェアの調達・設置
- 電源・ネットワークの確保
- OS のインストール・設定
- ミドルウェア（MySQL 等）のインストール
- パッチ適用・セキュリティ更新
- バックアップ設計・運用
- 監視設定

### EC2 での作業内容

- ✅ ハードウェア調達（AWS 側）
- ✅ OS インストール（AWS 側）
- 🔧 ミドルウェアインストール（ユーザー）
- 🔧 パッチ適用（ユーザー）
- 🔧 バックアップ設計（ユーザー）

### Amazon RDS での作業内容

- ✅ ハードウェア調達（AWS 側）
- ✅ OS インストール（AWS 側）
- ✅ ミドルウェアインストール（AWS 側）
- ✅ パッチ適用（AWS 側）
- ✅ バックアップ機能（AWS 側）
- 🎯 アプリケーションから利用（ユーザー）

## 🛠️ Amazon RDS の主要機能

### 対応データベースエンジン

- MySQL
- PostgreSQL
- MariaDB
- SQL Server
- Oracle Database
- Amazon Aurora（MySQL/PostgreSQL 互換）

### Multi-AZ 配置

- プライマリ・スタンバイ構成を簡単に構築
- 自動フェイルオーバー機能
- データの同期レプリケーション
- エンドポイント名は変わらずアプリケーション側の変更不要

### リードレプリカ

- 読み取り専用レプリカで負荷分散
- 参照系クエリの処理能力向上
- スケールアウト対応

### 自動バックアップ機能

- 指定したバックアップウィンドウで自動実行
- ポイントインタイム復旧対応
- 手動スナップショット取得も可能

### メンテナンス機能

- OS パッチ自動適用
- データベースエンジンのマイナーバージョンアップ
- メンテナンスウィンドウで実行タイミング制御

### パラメーター設定

- SSH アクセス不要でパラメーター変更
- パラメーターグループによる設定管理
- 即時反映または次回メンテナンス時反映を選択可能

## 🔧 実習：Amazon RDS 構築

### 前提条件の確認

1. EC2 インスタンス（Web-1A, DB-1A）が起動していることを確認
2. VPC、サブネット構成が Day4 の状態であること

### Step 1: 事前準備リソースの作成

#### 1.1 DB サブネットグループの作成

```
RDS → サブネットグループ → DBサブネットグループを作成
```

**設定値：**

- 名前: `udemy-aws-14days-db-subnet-group`
- 説明: `udemy-aws-14days-db-subnet-group`
- VPC: `udemy-aws-14days-vpc`
- アベイラビリティーゾーン: `ap-northeast-1a`, `ap-northeast-1c`
- サブネット: プライベートサブネット両方を選択

#### 1.2 パラメーターグループの作成

```
RDS → パラメーターグループ → パラメーターグループの作成
```

**設定値：**

- パラメーターグループ名: `udemy-aws-14days-mysql84-parameter-group`
- 説明: `udemy-aws-14days-mysql84-parameter-group`
- エンジンタイプ: `MySQL Community`
- パラメーターグループファミリー: `mysql8.4`

### Step 2: RDS インスタンスの作成

#### 2.1 データベース作成の開始

```
RDS → データベース → データベースの作成
```

#### 2.2 エンジン設定

- エンジンタイプ: `MySQL`
- エンジンバージョン: `8.4.5`（最新の 8.4 系）
- テンプレート: `開発/テスト`

#### 2.3 可用性と耐久性

- Multi-AZ DB インスタンス: `Multi-AZ DBインスタンスデプロイ（2インスタンス）`

#### 2.4 設定

- DB インスタンス識別子: `udemy-aws-14days-mysql`
- マスターユーザー名: `root`
- パスワード: `root!234`（セルフ管理を選択）

#### 2.5 インスタンス設定

- インスタンスクラス: `バースト可能クラス → db.t4g.micro`

#### 2.6 ストレージ

- ストレージタイプ: `汎用SSD（gp3）`
- 割り当てストレージ: `20GB`

#### 2.7 接続設定

- VPC: `udemy-aws-14days-vpc`
- DB サブネットグループ: `udemy-aws-14days-db-subnet-group`
- セキュリティグループ: `db-security-group`のみ選択

#### 2.8 追加設定

- データベースパラメーターグループ: `udemy-aws-14days-mysql84-parameter-group`
- 自動バックアップ: `有効`
- バックアップ保持期間: `2日`
- バックアップウィンドウ: `19:00-19:30 UTC`（日本時間 4:00-4:30）
- メンテナンスウィンドウ: `土曜日 20:00-20:30 UTC`（日本時間 日曜日 5:00-5:30）

### Step 3: パラメーター設定

#### 3.1 スロークエリログの有効化

```
RDS → パラメーターグループ → 作成したパラメーターグループ → 編集
```

**設定変更：**

- `slow_query_log`: `1`に変更
- 変更を保存

### Step 4: EC2 から RDS への接続設定

#### 4.1 CloudShell で EC2 に接続

```bash
ssh -i udemy-aws-14days.pem ec2-user@[Web-1AのパブリックIPアドレス]
```

#### 4.2 RDS に接続してデータベース構築

```bash
mysql -h [RDSエンドポイント] -u root -p
```

パスワード入力後、以下の SQL を実行：

```sql
-- ユーザー作成
CREATE USER 'simple-blog-user'@'%' IDENTIFIED BY 'user1234';
GRANT ALL PRIVILEGES ON *.* TO 'simple-blog-user'@'%';

-- データベース作成
CREATE DATABASE simple_blog;
USE simple_blog;

-- テーブル作成
CREATE TABLE posts (
    id INT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    content TEXT,
    data_source VARCHAR(50) DEFAULT 'rds'
);

-- データ挿入
INSERT INTO posts (title, content) VALUES
('Day1: AWSアカウント作成', 'AWSアカウントの作成方法について'),
('Day2: VPCの構築', 'VPCとサブネットの設定'),
('Day3: EC2インスタンス起動', 'WebサーバーとDBサーバーの構築'),
('Day4: EC2にMySQLインストール', 'EC2上でのMySQL設定');
```

#### 4.3 PHP アプリケーションの設定変更

```bash
sudo vim /var/www/html/index.php
```

データベース接続先を変更：

```php
$host = "[RDSエンドポイント]";
```

### Step 5: 動作確認

ブラウザで `http://[Web-1AのパブリックIP]` にアクセスし、RDS 経由でデータが表示されることを確認

## 📸 実習：スナップショット機能

### Step 1: 手動スナップショット作成

```
RDS → データベース → 対象インスタンスを選択 → アクション → スナップショットの取得
```

**設定値：**

- スナップショット名: `udemy-aws-14days-mysql-snapshot-manually`

### Step 2: データ削除（オペレーションミスの模擬）

```sql
mysql -h [RDSエンドポイント] -u simple-blog-user -p
USE simple_blog;
DELETE FROM posts WHERE id = 4;
```

### Step 3: スナップショットからの復元

```
RDS → スナップショット → 作成したスナップショット → アクション → スナップショットを復元
```

**設定値：**

- DB インスタンス識別子: `udemy-aws-14days-mysql-from-snapshot`
- インスタンスクラス: `db.t4g.micro`
- セキュリティグループ: `db-security-group`
- パラメーターグループ: `udemy-aws-14days-mysql84-parameter-group`

### Step 4: 復元確認

1. PHP アプリケーションの接続先を復元した RDS に変更
2. 削除したデータが復旧されていることを確認
3. 元の RDS に戻してリストア用 RDS を削除

## 🔄 実習：フェイルオーバー機能

### Step 1: 現在の AZ 確認

RDS インスタンスの詳細画面で、現在のプライマリ AZ とセカンダリ AZ を確認

### Step 2: フェイルオーバー前のデータ追加

```sql
INSERT INTO posts (title, content) VALUES
('Day5: Amazon RDS導入', 'マネージドサービスの活用');
```

### Step 3: フェイルオーバー実行

```
RDS → データベース → インスタンス選択 → アクション → 再起動
```

- `フェイルオーバーで再起動しますか？`にチェック
- 確認をクリック

### Step 4: フェイルオーバー確認

1. ログとイベントでフェイルオーバーの実行を確認
2. プライマリ AZ とセカンダリ AZ が入れ替わっていることを確認
3. アプリケーションでデータが引き続き表示されることを確認

### Step 5: フェイルバック実行

同様の手順でもう一度フェイルオーバーを実行し、元の AZ 構成に戻す

## 💰 コスト最適化：シングル AZ 構成への変更

### Multi-AZ からシングル AZ への変更

```
RDS → データベース → インスタンス選択 → 変更
```

**設定変更：**

- 可用性と耐久性: `スタンバイインスタンスを作成しない`
- すぐに適用: `有効`

### DB 用 EC2 インスタンスの削除

```
EC2 → インスタンス → DB-1A選択 → インスタンスの状態 → インスタンスを終了
```

## ⚠️ 注意事項

### RDS の停止制限

- RDS インスタンスは最大 7 日間しか停止できない
- 7 日後に自動的に再起動される
- 長期間使用しない場合はインスタンスを削除することを検討

### 料金管理

- Multi-AZ 配置は無料枠対象外
- 不要なリソースは適切に削除
- CloudWatch で料金アラートを設定

## 🎯 チェックポイント

### 完了確認項目

- [ ] RDS インスタンスが正常に作成されている
- [ ] EC2 から RDS に接続できる
- [ ] Web アプリケーションで RDS のデータが表示される
- [ ] パラメーターグループでの設定変更ができる
- [ ] スナップショットの取得・復元ができる
- [ ] Multi-AZ フェイルオーバーが動作する
- [ ] シングル AZ 構成に変更完了
- [ ] 不要なリソースを削除済み

## 🚀 オプショナルチャレンジ

### Challenge 1: Amazon Aurora の調査

Amazon Aurora の特徴と従来の RDS との違いについて公式ドキュメントで調査する

### Challenge 2: その他のデータベースサービス調査

AWS 提供のその他のデータベースマネージドサービスについて調査：

- Amazon DynamoDB（NoSQL）
- Amazon DocumentDB（MongoDB 互換）
- Amazon ElastiCache（インメモリ）
- Amazon Redshift（データウェアハウス）

## 📝 まとめ

Day5 では、Amazon RDS を使ってリレーショナルデータベースのマネージドサービスを活用しました。

**習得した技術：**

- マネージドサービスの概念と利点
- Amazon RDS の基本操作
- Multi-AZ 配置による高可用性
- 自動バックアップとスナップショット機能
- フェイルオーバー・フェイルバック機能
- パラメーターグループによる設定管理

**差別化されない重労働（Undifferentiated Heavy Lifting）**を回避し、ビジネス価値の創出により多くの時間を割けるようになりました。次の Day6 では、さらに多くのマネージドサービスを活用していきます。

---

**Day6 へ続く...**

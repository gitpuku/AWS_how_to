# Day12：体験していただきたい AWS サービス群詰め合わせ(CloudWatch/SNS/SQS/SES)

## 概要

この Day12 では、Web アプリケーション開発で頻繁に登場する AWS サービスについて学びます。以下の 4 つのサービスを実際に触りながら、基本的な使い方と設計面での活用方法を理解していきます。

### 対象サービス

- **Amazon CloudWatch** - AWS 監視サービス
- **Amazon SNS** - パブサブメッセージングサービス
- **Amazon SQS** - キューイングサービス
- **Amazon SES** - メール送受信サービス

---

## 1. Amazon CloudWatch & Amazon SNS

### 1.1 CloudWatch とは

- AWS リソースの運用監視を行うマネージドサービス
- 構築した AWS リソースの状況をメトリクスとして確認可能
- 監視対象のメトリクスを選んでアラートを作成できる

### 1.2 SNS とは

- パブサブメッセージングのためのサービス
- 疎結合なアーキテクチャを実現するキーサービス
- パブリッシャーとサブスクライバーの責務を分離

### 1.3 ハンズオン手順

#### Step 1: EC2 インスタンスの監視設定確認

1. マネジメントコンソールで EC2 画面に移動
2. バッチサーバーインスタンスを選択
3. 「モニタリング」タブで CloudWatch メトリクスを確認
4. インスタンス ID をコピー

#### Step 2: CloudWatch アラーム作成

1. CloudWatch サービス画面に移動
2. 「アラーム」→「アラームの作成」をクリック
3. 「メトリクスの選択」をクリック
4. 「EC2」を選択
5. インスタンス ID で検索してフィルタ
6. 「CPUUtilization」メトリクスを選択
7. 閾値を「50%」に設定
8. 「次へ」をクリック

#### Step 3: SNS トピック作成と通知設定

1. アラーム状態の設定で「新しいトピックの作成」を選択
2. トピック名：`batch-c-cpu-utilization-over-50_topic`
3. 通知を受け取る E メールアドレスを入力
4. 「トピックの作成」をクリック
5. アラーム名：`batch-c-cpu-utilization-over-50-alarm`
6. 「アラームの作成」をクリック

#### Step 4: SNS サブスクリプション確認

1. 指定したメールアドレスに確認メールが送信される
2. メール内の「Confirm subscription」リンクをクリック
3. CloudWatch コンソールでステータスが「確認済み」になることを確認

#### Step 5: アラーム動作テスト

1. CloudShell でバッチサーバーに SSH 接続

```bash
ssh -i udemy.pem ec2-user@[バッチサーバーのパブリックIP]
```

2. CPU 負荷をかけるコマンドを実行

```bash
yes > /dev/null &
yes > /dev/null &
yes > /dev/null &
```

3. CloudWatch アラームがアラーム状態になることを確認
4. アラートメールが送信されることを確認

#### Step 6: 後始末

1. 負荷テストプロセスを停止

```bash
top  # プロセス確認
# Qで終了
kill [yes コマンドのPID]
```

2. アラーム状態が OK 状態に戻ることを確認

---

## 2. Amazon SQS

### 2.1 SQS とは

- Amazon Simple Queue Service の略
- フルマネージドなキューイングサービス
- 処理の非同期化と疎結合を実現

### 2.2 SQS の主要機能

#### バルク処理

- プロデューサー、コンシューマー共に複数メッセージの一括処理が可能

#### ロングポーリング

- キューが空の場合でも一定時間ポーリングを継続
- コンシューマー側の問い合わせ回数を削減

#### ビジビリティタイムアウト

- 複数コンシューマー環境で同じメッセージの重複取得を防止
- メッセージ取得後、指定時間は他のコンシューマーから見えなくなる

#### 配信遅延（Delay Queue）

- メッセージ登録後、即座に処理開始したくない場合の時間調整

#### デッドレターキュー

- 処理に失敗し続けるメッセージを別キューに移動
- システムの安定性向上

### 2.3 ハンズオン手順

#### Step 1: SQS キュー作成

1. マネジメントコンソールで SQS サービス画面に移動
2. 「キューを作成」をクリック
3. キュー名：`udemy-aws-14days-queue`
4. 標準キューのまま「キューを作成」をクリック

#### Step 2: マネジメントコンソールからのメッセージ操作

1. 作成したキューをクリック
2. 「メッセージを送受信」をクリック
3. メッセージ送信テスト
   - メッセージ本文：「テストメッセージ」
   - 「送信」をクリック
4. メッセージ受信テスト
   - 「メッセージをポーリング」をクリック
   - 受信したメッセージを確認

#### Step 3: ビジビリティタイムアウトのテスト

1. キューの詳細 →「編集」をクリック
2. ビジビリティタイムアウトを「10 秒」に設定
3. 左右でブラウザを分割して同時ポーリングをテスト
4. 一方がメッセージを取得すると、他方では 10 秒間見えないことを確認

#### Step 4: 配信遅延のテスト

1. メッセージ送信時に配信遅延を「5 秒」に設定
2. 送信後すぐにはメッセージが見えないことを確認
3. 5 秒後にメッセージが表示されることを確認

#### Step 5: デッドレターキューのテスト

1. デッドレターキュー用のキューを作成
   - キュー名：`udemy-aws-14days-deadletter-queue`
2. 元のキューでデッドレターキューを有効化
3. 最大受信数を適切な値に設定
4. メッセージを繰り返し受信して閾値を超えた際の動作を確認

#### Step 6: プログラムからの SQS 操作

**前提設定**

```bash
# AWSクレデンシャル設定
aws configure
# リージョン: ap-northeast-1
# 出力形式: json
```

**IAM ロール権限追加**

- バッチサーバーの IAM ロールに SQS フルアクセス権限を追加

**メッセージ送信プログラム作成**

```bash
vim send_message.py
```

```python
import boto3

# SQSクライアント作成
sqs_client = boto3.client('sqs')

# メッセージ送信
response = sqs_client.send_message(
    QueueUrl='[キューのURL]',
    MessageBody='メッセージ from コード'
)

print("メッセージを送信しました")
```

**メッセージ受信プログラム**

```bash
cp udemy-aws-14days/Day12/receive_message.py .
vim receive_message.py
```

キュー URL を自分の環境に合わせて変更後、実行：

```bash
python3 send_message.py
python3 receive_message.py
```

---

## 3. Amazon SES

### 3.1 SES とは

- Amazon Simple Email Service の略
- AWS がフルマネージドで提供するメール送受信サービス
- 独自ドメインでのメール送信が可能

### 3.2 主要機能

#### 送信機能

- AWS SDK 経由でプログラムからメール送信
- 独自ドメインの設定
- バウンス処理による送信品質管理

#### 受信機能

- 独自ドメインでの受信
- 受信メールの S3 保存
- 自動返信などの後続処理

### 3.3 ハンズオン手順（※独自ドメイン必須）

#### Step 1: SES 初期設定

1. マネジメントコンソールで SES サービス画面に移動
2. 「使用開始」をクリック
3. 受信可能なメールアドレスを入力
4. 送信ドメイン（独自ドメイン）を入力
5. メール From ドメイン（例：mail.yourdomain.com）を設定
6. 「使用開始」をクリック

#### Step 2: メールアドレス検証

1. 入力したメールアドレスに検証メールが送信される
2. メール内のリンクをクリックして検証完了

#### Step 3: ドメイン検証

1. 設定 → アイデンティティでドメインを選択
2. DKIM とカスタムメール From ドメインの「DNS レコードを Route 53 へ発行」をクリック
3. 検証完了まで数分待機（ステータスが「検証済み」になるまで）

#### Step 4: マネジメントコンソールからのメール送信テスト

1. 「テスト E メールの送信」をクリック
2. 送信設定：
   - From: 設定したドメイン
   - シナリオ: カスタム
   - To: 検証済みメールアドレス（サンドボックス制約）
   - 件名と本文を入力
3. 「テスト E メールの送信」を実行
4. メール受信を確認

#### Step 5: プログラムからのメール送信

**IAM ロール権限追加**

- バッチサーバーの IAM ロールに SES フルアクセス権限を追加

**メール送信プログラム**

```bash
cp udemy-aws-14days/Day12/send_email.py .
vim send_email.py
```

To アドレスと From アドレスを自分の環境に合わせて変更：

```python
import boto3

# SESクライアント作成
ses_client = boto3.client('ses')

# メール送信
response = ses_client.send_email(
    Source='hetancho@yourdomain.com',
    Destination={
        'ToAddresses': ['your-verified-email@example.com']
    },
    Message={
        'Subject': {
            'Data': 'udemy AWS 14days 12日目'
        },
        'Body': {
            'Text': {
                'Data': 'Amazon SESを使っています'
            }
        }
    }
)

print("メールを送信しました")
```

実行：

```bash
python3 send_email.py
```

---

## 4. リソース削除

### 削除対象リソース

以下の手順で Day12 で作成したリソースを削除します：

#### CloudWatch

1. アラーム一覧から作成したアラームを選択
2. 「アクション」→「削除」

#### SNS

1. サブスクリプション一覧から作成したサブスクリプションを削除
2. トピック一覧から作成したトピックを削除

#### SQS

1. 作成した通常キューとデッドレターキューを削除
2. 各キューを選択して「削除」→ 確認

#### SES

- 継続利用予定がない場合：
  - アイデンティティから登録したドメインとメールアドレスを削除
  - Route 53 の DNS レコードも削除

---

## 5. まとめ

Day12 では以下 4 つの AWS サービスについて学習しました：

### CloudWatch

- システム運用で必須の監視サービス
- メトリクス監視とアラート機能
- カスタムメトリクスとダッシュボード

### SNS

- パブサブメッセージングによる疎結合アーキテクチャの実現
- 複数サブスクライバーへの通知配信
- 設計の柔軟性向上

### SQS

- 非同期処理とキューイング
- 豊富な機能（ロングポーリング、デッドレターキューなど）
- 標準キューと FIFO キューの使い分け

### SES

- フルマネージドメール送受信サービス
- 独自ドメインでの送信
- バウンス処理の重要性

---

## 6. プラスアルファチャレンジ

### チャレンジ 1: SQS デッドレターキューの監視

- デッドレターキューのメッセージ数を CloudWatch で監視
- メッセージが蓄積された際のアラート設定

### チャレンジ 2: SNS の多様なサブスクリプション

- SNS のサブスクリプションで様々なプロトコル（HTTP/HTTPS、SQS 等）を試行
- SNS から SQS へのメッセージ配信パターンの実装

### チャレンジ 3: SES バウンス処理の実装調査

- メール配信失敗時のバウンス処理実装方法の調査
- 配信できないメールアドレスの管理手法の検討

これらのサービスは今後の AWS 設計において重要な選択肢となります。システム要件に応じて適切に活用していきましょう。

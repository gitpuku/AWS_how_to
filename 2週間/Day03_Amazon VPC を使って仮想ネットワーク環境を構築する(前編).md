# Day3: Amazon VPC を使って仮想ネットワーク環境を構築する(前編)

## 概要

Day3 では、Amazon VPC を使って仮想ネットワーク環境を構築します。インターネットからアクセスを許すパブリックサブネットを作成し、そこに EC2 インスタンスを立てて Web サーバーとして設定していきます。

## 学習目標

- AWS におけるネットワークの基本概念（リージョン、AZ、VPC、サブネット）を理解する
- VPC とパブリックサブネットを作成する
- EC2 インスタンスを VPC 上に構築する
- Apache + PHP で Web サーバーを構築する

## ネットワーク基本概念

### リージョンとアベイラビリティーゾーン（AZ）

- **リージョン**: 世界各国にあるデータセンターを地理的エリアでグループ化したもの
- **アベイラビリティーゾーン（AZ）**: 同一リージョン内で物理的に分離されたデータセンター群
- **マルチ AZ 構成**: 複数の AZ にまたがってリソースを配置し、耐障害性を向上

### Amazon VPC（Virtual Private Cloud）

- AWS 上に独立したネットワーク環境を作成するサービス
- ネットワークの広さは CIDR 記法で定義（例：10.0.0.0/16）
- AZ をまたがる形で作成される

### サブネット

- VPC 内をさらに細かく区切ったネットワーク単位
- 各サブネットは特定の AZ に紐づく
- **パブリックサブネット**: インターネットからの直接アクセスが可能
- **プライベートサブネット**: インターネットからの直接アクセス不可

### CIDR 記法について

- IP アドレスの範囲を示す表記法
- `/32`: 単一 IP アドレス
- `/24`: 約 251 個の IP アドレス（256-5 個の予約アドレス）
- `/16`: 約 65,000 個の IP アドレス

## 構築する全体構成

```
東京リージョン
├── VPC (10.0.0.0/16)
    ├── パブリックサブネット 1A (10.0.1.0/24)
    │   └── EC2インスタンス（Webサーバー）
    ├── パブリックサブネット 1C (10.0.2.0/24)
    ├── インターネットゲートウェイ
    └── ルートテーブル
```

## 操作手順

### Step 1: VPC の作成

1. **AWS マネジメントコンソールにログイン**

   - 東京リージョンが選択されていることを確認

2. **VPC サービスへ移動**

   - 検索窓で「VPC」を検索してサービスメニューに移動

3. **VPC を作成**
   - 「VPC を作成」ボタンをクリック
   - 作成方法: 「VPC のみ」を選択
   - 名前: `udemy-aws-14days-vpc`
   - IPv4 CIDR ブロック: `10.0.0.0/16`
   - 「VPC を作成」をクリック

### Step 2: インターネットゲートウェイの作成とアタッチ

1. **インターネットゲートウェイを作成**

   - 左メニューから「インターネットゲートウェイ」を選択
   - 「インターネットゲートウェイの作成」をクリック
   - 名前: `udemy-aws-14days-igw`
   - 「インターネットゲートウェイを作成」をクリック

2. **VPC にアタッチ**
   - 作成完了後の画面で「VPC にアタッチ」をクリック
   - 先ほど作成した`udemy-aws-14days-vpc`を選択
   - 「インターネットゲートウェイをアタッチ」をクリック

### Step 3: パブリックサブネットの作成（AZ 1a）

1. **サブネットを作成**
   - 左メニューから「サブネット」を選択
   - 「サブネットを作成」をクリック
   - VPC: `udemy-aws-14days-vpc`を選択
   - サブネット名: `udemy-aws-14days-public-subnet-1a`
   - アベイラビリティーゾーン: `ap-northeast-1a`
   - IPv4 CIDR ブロック: `10.0.1.0/24`
   - 「サブネットを作成」をクリック

### Step 4: ルートテーブルの作成と設定

1. **ルートテーブルを作成**

   - 左メニューから「ルートテーブル」を選択
   - 「ルートテーブルを作成」をクリック
   - 名前: `udemy-aws-14days-public-route-table`
   - VPC: `udemy-aws-14days-vpc`を選択
   - 「ルートテーブルを作成」をクリック

2. **ルートを編集**

   - 作成したルートテーブルを選択
   - 「ルートを編集」をクリック
   - 「ルートを追加」をクリック
   - 送信先: `0.0.0.0/0`
   - ターゲット: 「インターネットゲートウェイ」を選択し、作成した IGW を指定
   - 「変更を保存」をクリック

3. **サブネットの関連付け**
   - 「サブネットの関連付け」タブを選択
   - 「サブネットの関連付けを編集」をクリック
   - `public-subnet-1a`にチェックを入れる
   - 「関連付けを保存」をクリック

### Step 5: パブリックサブネットの作成（AZ 1c）

1. **2 つ目のサブネットを作成**

   - 「サブネットを作成」をクリック
   - VPC: `udemy-aws-14days-vpc`を選択
   - サブネット名: `udemy-aws-14days-public-subnet-1c`
   - アベイラビリティーゾーン: `ap-northeast-1c`
   - IPv4 CIDR ブロック: `10.0.2.0/24`
   - 「サブネットを作成」をクリック

2. **ルートテーブルに関連付け**
   - 先ほど作成したルートテーブルを選択
   - 「サブネットの関連付け」タブで「編集」をクリック
   - `public-subnet-1c`にもチェックを入れる
   - 「関連付けを保存」をクリック

### Step 6: パブリック IP の自動割り当て設定

1. **サブネット 1a の設定**

   - `public-subnet-1a`を選択
   - 「アクション」→「サブネットの設定を編集」
   - 「パブリック IPv4 アドレスを自動割り当て」にチェック
   - 「保存」をクリック

2. **サブネット 1c の設定**
   - 同様に`public-subnet-1c`でも設定を実施

### Step 7: EC2 インスタンスの作成

1. **EC2 サービスへ移動**

   - 検索窓で「EC2」を検索

2. **インスタンスを起動**

   - 「インスタンスを起動」をクリック
   - 名前: `web-1a`
   - AMI: Amazon Linux 2023 AMI
   - インスタンスタイプ: t2.micro
   - キーペア: Day2 で作成したキーペアを選択

3. **ネットワーク設定**

   - 「ネットワーク設定の編集」をクリック
   - VPC: `udemy-aws-14days-vpc`を選択
   - サブネット: `public-subnet-1a`を選択
   - パブリック IP の自動割り当て: 有効化

4. **セキュリティグループ設定**

   - 新しいセキュリティグループを作成
   - セキュリティグループ名: `web-sg`
   - 説明: `web-sg`
   - インバウンドルール:
     - SSH (ポート 22): 任意の場所 (0.0.0.0/0)
     - HTTP (ポート 80): 任意の場所 (0.0.0.0/0)

5. **高度なネットワーク設定**

   - プライベート IP アドレス: `10.0.1.10`

6. **インスタンスを起動**

### Step 8: Web サーバーの設定

1. **CloudShell またはターミナルで接続**

   ```bash
   ssh -i udemy-aws-14days.pem ec2-user@[パブリックIPアドレス]
   ```

2. **OS 設定の変更**

   ```bash
   # ホスト名の変更
   sudo hostnamectl set-hostname udemy-aws-14days-web-1a

   # ロケールの変更
   sudo localectl set-locale LANG=ja_JP.utf8
   source /etc/locale.conf

   # タイムゾーンの変更
   sudo timedatectl set-timezone Asia/Tokyo
   ```

3. **パッケージの更新と Apache のインストール**

   ```bash
   # パッケージ更新
   sudo dnf update -y

   # Apache HTTPDのインストール
   sudo dnf install httpd -y

   # Apache自動起動設定
   sudo systemctl enable httpd

   # Apache起動
   sudo systemctl start httpd
   ```

4. **動作確認**
   - ブラウザでパブリック IP アドレスにアクセス
   - Apache のテストページが表示されることを確認

### Step 9: PHP の設定とアプリケーションのデプロイ

1. **PHP のインストール**

   ```bash
   sudo dnf install php8.4 -y
   ```

2. **Apache 設定ファイルの編集**

   ```bash
   sudo vim /etc/httpd/conf/httpd.conf
   ```

   以下の設定を変更:

   - DirectoryIndex に index.php を追加
   - ServerName のコメントアウトを外し、適切な値を設定

3. **Git のインストールとソースコード取得**

   ```bash
   sudo dnf install git -y
   git clone https://github.com/[リポジトリ]/udemy-aws-14days.git
   ```

4. **アプリケーションファイルのコピー**

   ```bash
   sudo cp -R udemy-aws-14days/Day03/* /var/www/html/
   ```

5. **Apache の再起動**

   ```bash
   sudo systemctl stop httpd
   sudo systemctl start httpd
   ```

6. **動作確認**
   - ブラウザでパブリック IP アドレスにアクセス
   - シンプルブログアプリケーションが表示されることを確認

## まとめ

Day3 では以下を実施しました：

### 学習したキーワード

- リージョン
- アベイラビリティーゾーン（AZ）
- VPC（Virtual Private Cloud）
- サブネット
- ルートテーブル
- インターネットゲートウェイ
- CIDR 記法

### 構築した内容

1. 独自 VPC の作成（10.0.0.0/16）
2. パブリックサブネットの作成（2 つの AZ に配置）
3. インターネットゲートウェイの作成とアタッチ
4. ルートテーブルの設定
5. EC2 インスタンスの起動（VPC 上）
6. Apache + PHP での Web サーバー構築
7. 簡易ブログアプリケーションのデプロイ

## プラスアルファチャレンジ

### チャレンジ 1: ホワイトボーディング

- 今回構築した構成を何も見ずに紙に書いてみましょう
- 各コンポーネントの関係性を整理して理解を深めます

### チャレンジ 2: 設定項目の調査

- VPC とサブネットの設定項目を確認してみましょう
- 今回触れなかった設定項目を 1 つ以上見つけて調べてみましょう

## 次回予告

Day4 では、プライベートサブネットの作成と NAT ゲートウェイの設定、データベース用 EC2 インスタンスの構築を行います。

---

**注意事項**

- ハンズオン環境での学習のため、セキュリティグループは 0.0.0.0/0 での設定としていますが、本番環境では適切な IP 制限を行ってください
- 使用後はリソースの削除を忘れずに行ってください

# Day7：オブジェクトストレージサービス Amazon S3 を使ってみる

## 概要

Day7 では、Amazon S3（Simple Storage Service）というオブジェクトストレージサービスを学習します。S3 は Amazon EC2 と並んで代表的な AWS サービスの一つで、ファイル置き場のような機能を提供します。

### 学習目標

- Amazon S3 の基本概念と特徴を理解する
- S3 バケットの作成と設定方法を習得する
- シンプルブログの画像を S3 に移行する
- S3 の静的ウェブサイトホスティング機能を体験する

## Amazon S3 の基本知識

### Amazon S3 とは

- **正式名称**: Amazon Simple Storage Service
- **概要**: 安価で耐久性の高いオブジェクトストレージサービス
- **料金**: 月 1GB で 0.025 ドル（約 3.75 円、150 円/ドル換算）
- **耐久性**: イレブンナイン（99.999999999%）の耐久性

### S3 の特徴

1. **高い耐久性**: 最低 3 つのアベイラビリティゾーンに自動的にデータを保存
2. **安価な料金**: EBS の約 1/4 のコスト
3. **スケーラビリティ**: 容量制限なし
4. **セキュリティ**: IAM によるアクセス制御、IP アドレス制限など

### S3 の主な利用シーン

1. **画像・ファイルの格納**: Web アプリケーションの静的コンテンツ
2. **ログの保管**: 長期間の安価なログ保存
3. **システム間連携**: ファイルを介したデータ交換
4. **静的ウェブサイト**: HTML ファイルのホスティング

### VPC との関係

- S3 は VPC の外で動作するサービス
- EC2、RDS、ELB とは異なり、VPC を指定しない

## ハンズオン 1: S3 バケットの作成と画像ファイルの移行

### 前提条件

- シンプルブログが動作していること
- 補足資料の画像ファイル 4 つをローカル PC に保存済み

### 手順 1: 既存の CloudTrail バケットの確認

1. AWS マネジメントコンソールにログイン
2. サービス検索で「S3」を入力して S3 画面に移動
3. CloudTrail のバケットをクリックして中身を確認
   - フォルダ階層を辿ってログファイルを確認
   - S3 の基本的な構造を理解

### 手順 2: 画像用 S3 バケットの作成

1. **バケット作成**

   ```
   「バケットを作成」をクリック
   ```

2. **バケット名の設定**

   - バケット名: `udemy-aws14days-webimages-[自分の名前や日付]`
   - ⚠️ **注意**: バケット名は全世界で一意である必要があります
   - 3 文字～ 63 文字で設定

3. **パブリックアクセス設定**

   - 「パブリックアクセスをすべてブロック」のチェックを外す
   - 確認メッセージが表示されたらチェックを入れる

4. **バケット作成の実行**
   ```
   「バケットを作成」をクリック
   ```

### 手順 3: バケットポリシーの設定

1. **アクセス許可タブに移動**

   ```
   作成したバケット名をクリック → 「アクセス許可」タブ
   ```

2. **バケットポリシーの編集**

   - 「バケットポリシー」の「編集」をクリック
   - 以下のポリシーをコピー＆ペースト（バケット名を自分のものに変更）:

   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Sid": "PublicReadGetObject",
         "Effect": "Allow",
         "Principal": "*",
         "Action": "s3:GetObject",
         "Resource": "arn:aws:s3:::YOUR-BUCKET-NAME/*"
       }
     ]
   }
   ```

3. **設定の保存**
   ```
   「変更の保存」をクリック
   ```

### 手順 4: フォルダ作成とファイルアップロード

1. **フォルダの作成**

   ```
   「オブジェクト」タブ → 「フォルダの作成」
   フォルダ名: images
   「フォルダを作成」をクリック
   ```

2. **画像ファイルのアップロード**

   - `images`フォルダをクリックして入る
   - 「アップロード」をクリック
   - 補足資料の画像ファイル 4 つをドラッグ＆ドロップ
   - 「アップロード」をクリック

3. **アップロード確認**

   - 「閉じる」をクリック
   - 4 つの画像ファイルが表示されることを確認

4. **アクセステスト**
   - 任意の画像ファイルをクリック
   - 「オブジェクト URL」をコピー
   - 新しいタブで URL にアクセスして画像が表示されることを確認

## ハンズオン 2: データベースの画像参照先変更

### 前提条件

- Web EC2 インスタンスが実行中であること
- RDS エンドポイントの情報を把握していること

### 手順 1: EC2 への接続

1. **EC2 の確認**

   - Web EC2 インスタンスが実行中であることを確認
   - パブリック IP アドレスをコピー

2. **SSH 接続**
   ```bash
   ssh -i udemy.pem ec2-user@[パブリックIPアドレス]
   ```

### 手順 2: MySQL への接続とデータ更新

1. **MySQL に接続**

   ```bash
   mysql -h [RDSエンドポイント] -u simplebloguser -p
   ```

2. **データベース選択**

   ```sql
   USE simpleblog;
   ```

3. **現在のデータ確認**

   ```sql
   SELECT * FROM posts;
   ```

4. **既存データの削除**

   ```sql
   DELETE FROM posts;
   ```

5. **新しいデータの挿入**

   ```sql
   INSERT INTO posts (title, content, image) VALUES
   ('記事1', '内容1', 'https://s3.ap-northeast-1.amazonaws.com/[YOUR-BUCKET-NAME]/images/image1.jpg'),
   ('記事2', '内容2', 'https://s3.ap-northeast-1.amazonaws.com/[YOUR-BUCKET-NAME]/images/image2.jpg'),
   ('記事3', '内容3', 'https://s3.ap-northeast-1.amazonaws.com/[YOUR-BUCKET-NAME]/images/image3.jpg'),
   ('記事4', '内容4', 'https://s3.ap-northeast-1.amazonaws.com/[YOUR-BUCKET-NAME]/images/image4.jpg');
   ```

   ⚠️ **注意**: `[YOUR-BUCKET-NAME]`を実際のバケット名に置き換える

6. **データの確認**
   ```sql
   SELECT * FROM posts;
   ```

### 手順 3: ブラウザでの確認

1. シンプルブログのページをリロード
2. S3 上の画像が表示されることを確認
3. 画像に S3 マークが付いていることを確認（講師が加工済み）

## ハンズオン 3: S3 静的ウェブサイトホスティング

### 概要

シンプルブログに障害が発生した時用のソーリーページを作成します。

### 注意事項

- Day8 でドメイン取得を行う予定（任意）
- ドメイン取得する場合は、バケット名とドメイン名を一致させる必要がある
- 後からやり直すことも可能

### 手順 1: 静的ウェブサイト用バケットの作成

1. **バケット作成**

   ```
   S3画面 → 「バケットを作成」
   ```

2. **バケット名の設定**

   - バケット名例: `simpleblog.udemy-aws14days.net`
   - ⚠️ **重要**: 後でドメインを取得する場合は、そのドメイン名と一致させる

3. **バケット作成の実行**
   ```
   その他の設定はデフォルトのまま
   「バケットを作成」をクリック
   ```

### 手順 2: パブリックアクセス設定

1. **バケット設定**

   ```
   作成したバケット名をクリック → 「アクセス許可」タブ
   ```

2. **ブロックパブリックアクセスの編集**

   ```
   「ブロックパブリックアクセス」の「編集」をクリック
   「パブリックアクセスをすべてブロック」のチェックを外す
   「変更の保存」をクリック
   確認画面で「確認」をクリック
   ```

3. **バケットポリシーの設定**

   ```
   「バケットポリシー」の「編集」をクリック
   ```

   以下のポリシーを設定（バケット名を適切に変更）:

   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Sid": "PublicReadGetObject",
         "Effect": "Allow",
         "Principal": "*",
         "Action": "s3:GetObject",
         "Resource": "arn:aws:s3:::YOUR-BUCKET-NAME/*"
       }
     ]
   }
   ```

### 手順 3: 静的ウェブサイトホスティングの有効化

1. **プロパティタブに移動**

   ```
   「プロパティ」タブをクリック
   ```

2. **静的ウェブサイトホスティングの設定**
   ```
   最下部の「静的ウェブサイトホスティング」の「編集」をクリック
   「有効」を選択
   「静的ウェブサイトをホスト」を選択
   インデックスドキュメント: index.html
   「変更の保存」をクリック
   ```

### 手順 4: HTML ファイルのアップロード

1. **ファイルアップロード**

   ```
   「オブジェクト」タブに戻る
   補足資料のindex.htmlファイルをドラッグ&ドロップ
   「アップロード」をクリック
   ```

2. **アップロード完了**
   ```
   「閉じる」をクリック
   ```

### 手順 5: ウェブサイトの確認

1. **エンドポイントの取得**

   ```
   「プロパティ」タブ → 最下部の「静的ウェブサイトホスティング」
   「バケットウェブサイトエンドポイント」をコピー
   ```

2. **ブラウザでアクセス**
   ```
   新しいタブでエンドポイントURLにアクセス
   「メンテナンス中です」というソーリーページが表示されることを確認
   ```

## まとめ

### 実施内容の振り返り

1. **Amazon S3 の基本知識習得**

   - オブジェクトストレージの概念
   - 料金体系と耐久性
   - 他の AWS サービスとの連携

2. **S3 バケットの作成と運用**

   - パブリックアクセス設定
   - バケットポリシーの設定
   - ファイルのアップロードと管理

3. **アプリケーションとの連携**

   - データベースの画像参照先を S3 に変更
   - ステートレスなアーキテクチャの実現

4. **静的ウェブサイトホスティング**
   - 簡単な HTML ページのホスティング
   - 障害時のソーリーページ作成

### 重要なポイント

- **VPC との関係**: S3 は VPC 外のサービス
- **グローバルユニーク**: バケット名は全世界で一意
- **セキュリティ**: パブリックアクセス設定とバケットポリシーの重要性
- **コスト効率**: EBS と比較して約 1/4 のコスト

### プラスアルファチャレンジ

1. **設定項目の調査**

   - 作成した S3 バケットの各種設定項目を調査
   - 今回使用しなかった機能の意味を調べる

2. **他の AWS サービスとの連携調査**
   - S3 と連携可能な AWS サービスを調査
   - 具体的な連携方法を調べる

### 次回予告

Day8 では、Route 53 を使用したドメイン名の取得と DNS 設定を学習予定です。今回作成した静的ウェブサイトとの連携も行います。

---

**注意**: この手順書は音声認識による自動転写を基に作成されているため、実際の操作画面や設定項目名が異なる場合があります。AWS Management Console の最新の画面に合わせて適宜読み替えてください。

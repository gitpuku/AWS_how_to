# Day4: Amazon VPC を使って仮想ネットワーク環境を構築する(後編)

## 概要

Day4 では、Amazon VPC を使って仮想ネットワーク環境を構築する後編として、プライベートサブネットの作成とデータベースサーバーの構築を行います。前回の Day3 の続きから、シンプルブログアプリケーションをデータベース連携型に進化させます。

## 学習目標

- プライベートサブネットの概念と作成方法を理解する
- セキュリティグループの高度な設定（セキュリティグループ間の参照）を学ぶ
- NAT Gateway の役割と設定方法を理解する
- データベースサーバーの構築と MySQL のインストール
- ウェブサーバーとデータベースサーバー間の通信設定

## 構成図

Day4 完了時の構成：

```
VPC (10.0.0.0/16)
├── Public Subnet 1a (10.0.1.0/24)
│   ├── Web Server (EC2)
│   └── Internet Gateway
├── Public Subnet 1c (10.0.2.0/24)
├── Private Subnet 1a (10.0.101.0/24)
│   └── DB Server (EC2)
└── Private Subnet 1c (10.0.102.0/24)
```

## Day4 の流れ

1. **プライベートサブネットの作成**
2. **プライベートサブネット用ルートテーブルの作成**
3. **DB サーバー用 EC2 インスタンスの作成**
4. **セキュリティグループの設定（セキュリティグループ間参照）**
5. **踏み台サーバーを使った DB 接続**
6. **NAT Gateway の作成と設定**
7. **MySQL のインストールと設定**
8. **データベースとテーブルの作成**
9. **シンプルブログアプリケーションの DB 連携化**
10. **リソースの整理と削除**

---

## 1. プライベートサブネットの作成

### 手順

1. **VPC ダッシュボードにアクセス**

   - AWS マネジメントコンソールにログイン
   - VPC サービスに移動

2. **VPC フィルターの設定**

   - VPC でフィルタリングのプルダウンから「udemy-aws-14days-vpc」を選択
   - これにより、作成した VPC 関連のリソースのみが表示されます

3. **サブネットの作成**

   - 左側メニューから「サブネット」を選択
   - 「サブネットを作成」をクリック

4. **1 つ目のプライベートサブネット設定**

   - **VPC**: udemy-aws-14days-vpc
   - **サブネット名**: udemy-aws-14days-private-subnet-1a
   - **アベイラビリティゾーン**: ap-northeast-1a
   - **IPv4 CIDR ブロック**: 10.0.101.0/24

5. **2 つ目のプライベートサブネット設定**

   - 「新しいサブネット」をクリック
   - **サブネット名**: udemy-aws-14days-private-subnet-1c
   - **アベイラビリティゾーン**: ap-northeast-1c
   - **IPv4 CIDR ブロック**: 10.0.102.0/24

6. **サブネット作成の実行**
   - 「サブネットを作成」をクリック

### ポイント

- 第 3 オクテットを 3 桁（101, 102）にすることで、プライベートサブネットであることを視覚的に分かりやすくしています

---

## 2. プライベートサブネット用ルートテーブルの作成

### 手順

1. **ルートテーブルの作成**

   - 左側メニューから「ルートテーブル」を選択
   - 「ルートテーブルを作成」をクリック

2. **ルートテーブル設定**

   - **名前**: udemy-aws-14days-private-subnet-route-table
   - **VPC**: udemy-aws-14days-vpc
   - 「ルートテーブルを作成」をクリック

3. **サブネットの関連付け**
   - 作成したルートテーブルを選択
   - 「サブネットの関連付け」タブをクリック
   - 「サブネットの関連付けを編集」をクリック
   - プライベートサブネット 1a とプライベートサブネット 1c を選択
   - 「関連付けを保存」をクリック

### ポイント

- プライベートサブネット用のルートテーブルには、インターネットゲートウェイへのルートを設定しません
- これにより、プライベートサブネット内のリソースは直接インターネットにアクセスできません

---

## 3. DB サーバー用 EC2 インスタンスの作成

### 手順

1. **EC2 ダッシュボードにアクセス**

   - EC2 サービスに移動
   - 「インスタンスを起動」をクリック

2. **基本設定**

   - **名前**: db-1a
   - **AMI**: Amazon Linux 2023
   - **インスタンスタイプ**: t2.micro（無料利用枠対象）

3. **キーペア設定**

   - 既存のキーペア「udemy-aws-14days」を選択

4. **ネットワーク設定**
   - 「編集」をクリック
   - **VPC**: udemy-aws-14days-vpc
   - **サブネット**: udemy-aws-14days-private-subnet-1a
   - **パブリック IP の自動割り当て**: 無効

### 料金に関する注意

無料利用枠は月 750 時間までです。2 つのインスタンスを同時実行すると、月 1500 時間となり無料枠を超過します。14 日間程度の利用であれば無料枠内に収まります。

---

## 4. セキュリティグループの設定

### セキュリティグループ間参照の概念

セキュリティグループの条件として、特定のセキュリティグループがアタッチされたインスタンスからの通信のみを許可する設定が可能です。

例：

- Web サーバーのセキュリティグループがアタッチされたインスタンスからの MySQL 通信のみ許可
- 他のインスタンスからの MySQL 通信は拒否

### DB サーバー用セキュリティグループの作成

1. **セキュリティグループ設定**

   - 「新しいセキュリティグループを作成」を選択
   - **セキュリティグループ名**: db-sg
   - **説明**: DB 用のセキュリティグループ

2. **インバウンドルール設定**

   **ルール 1: SSH 接続**

   - **タイプ**: SSH
   - **ソース**: カスタム → 「web」と入力して web-sg を選択

   **ルール 2: MySQL 接続**

   - 「セキュリティグループルールを追加」をクリック
   - **タイプ**: MYSQL/Aurora
   - **ソース**: カスタム → 「web」と入力して web-sg を選択

3. **プライベート IP アドレスの固定**

   - 「高度な詳細」を展開
   - **プライベート IP アドレス**: 10.0.101.20

4. **ユーザーデータの設定**

   ```bash
   #!/bin/bash
   hostnamectl set-hostname db-1a
   localectl set-locale LANG=ja_JP.UTF-8
   timedatectl set-timezone Asia/Tokyo
   ```

5. **インスタンス起動**
   - 「インスタンスを起動」をクリック

---

## 5. 踏み台サーバーを使った DB 接続

### 概念

プライベートサブネット内のインスタンスには直接 SSH 接続できないため、パブリックサブネット内の Web サーバーを「踏み台」として使用します。

### 手順

1. **PEM ファイルを Web サーバーにコピー**

   ```bash
   # CloudShellまたはローカルターミナルから実行
   scp -i udemy-aws-14days.pem udemy-aws-14days.pem ec2-user@[WebサーバーのパブリックIP]:~
   ```

2. **Web サーバーに接続**

   ```bash
   ssh -i udemy-aws-14days.pem ec2-user@[WebサーバーのパブリックIP]
   ```

3. **Web サーバーから DB サーバーに接続**

   ```bash
   ssh -i udemy-aws-14days.pem ec2-user@10.0.101.20
   ```

4. **MySQL のインストール試行（失敗例）**

   ```bash
   sudo dnf update -y
   ```

   ※ この時点では外部インターネットへの接続ができないため、コマンドが応答しません

   Ctrl+C でコマンドを中断します。

### 問題の確認

プライベートサブネット内のインスタンスは、外部インターネットへの接続経路がないため、パッケージのダウンロードやアップデートができません。

---

## 6. NAT Gateway の作成と設定

### NAT Gateway の概念

NAT Gateway（Network Address Translation Gateway）は、プライベートサブネット内のインスタンスが外部インターネットに接続するためのサービスです。一方向の通信（内側から外側）のみを許可します。

### 料金について

- 東京リージョン: 1 時間あたり$0.062（約 10 円/時間、$1=¥150 換算）
- 日をまたがずに Day4 を完了することを推奨

### 手順

1. **NAT Gateway の作成**

   - VPC ダッシュボードで「NAT Gateway」を選択
   - 「NAT Gateway を作成」をクリック

2. **設定**

   - **名前**: udemy-aws-14days-natgateway-ngw
   - **サブネット**: udemy-aws-14days-public-subnet-1a
   - **Elastic IP 割り当て**: 「EIP を割り当て」をクリック

3. **NAT Gateway 作成の実行**

   - 「NAT Gateway を作成」をクリック
   - ステータスが「Available」になるまで 2-3 分待機

4. **ルートテーブルの更新**
   - 「ルートテーブル」に移動
   - プライベートサブネット用ルートテーブルを選択
   - 「ルート」タブ → 「ルートを編集」をクリック
   - 「ルートを追加」をクリック
   - **送信先**: 0.0.0.0/0
   - **ターゲット**: NAT Gateway → 作成した NAT Gateway を選択
   - 「変更を保存」をクリック

---

## 7. MySQL のインストールと設定

### 手順

1. **DB サーバーへの再接続**

   - CloudShell → Web サーバー → DB サーバーの順に接続

2. **システムアップデート**

   ```bash
   sudo dnf update -y
   ```

   ※ 今度は正常に実行されます

3. **MySQL のインストール**

   ```bash
   # MySQL repositoryの追加
   sudo dnf install -y https://dev.mysql.com/get/mysql80-community-release-el9-1.noarch.rpm

   # MySQLサーバーとクライアントのインストール
   sudo dnf install -y mysql-community-server
   ```

4. **MySQL サービスの開始**

   ```bash
   # MySQLサービス開始
   sudo systemctl start mysqld

   # 自動起動設定
   sudo systemctl enable mysqld
   ```

5. **初期パスワードの確認**

   ```bash
   sudo grep 'temporary password' /var/log/mysqld.log
   ```

   表示された一時パスワードをコピーしておきます

6. **MySQL にログイン**

   ```bash
   mysql -u root -p
   ```

   一時パスワードを入力

7. **root パスワードの変更**

   ```sql
   ALTER USER 'root'@'localhost' IDENTIFIED BY 'Root!234';
   ```

8. **MySQL からログアウトして再接続テスト**
   ```bash
   exit
   mysql -u root -p
   ```
   新しいパスワードで接続確認

---

## 8. データベースとテーブルの作成

### 手順

1. **データベースの作成**

   ```sql
   CREATE DATABASE simpleblog;
   USE simpleblog;
   ```

2. **テーブルの作成**

   ```sql
   CREATE TABLE posts (
       id INT AUTO_INCREMENT PRIMARY KEY,
       title VARCHAR(255) NOT NULL,
       content TEXT NOT NULL,
       image_url VARCHAR(255)
   );
   ```

3. **サンプルデータの挿入**

   ```sql
   INSERT INTO posts (title, content, image_url) VALUES
   ('DB 今日のランチ', '今日のランチは美味しいカレーでした！スパイスが効いていて最高です。', 'https://via.placeholder.com/400x200?text=Curry'),
   ('DB 週末の散歩', '近所の公園を散歩してきました。桜が咲いていてとても綺麗でした。', 'https://via.placeholder.com/400x200?text=Park'),
   ('DB 新しい本', '面白い小説を読み始めました。ストーリーが予想外の展開で夢中になっています。', 'https://via.placeholder.com/400x200?text=Book'),
   ('DB 映画鑑賞', '話題の映画を観てきました。映像美が素晴らしく、感動しました。', 'https://via.placeholder.com/400x200?text=Movie');
   ```

4. **データの確認**

   ```sql
   SELECT * FROM posts;
   ```

5. **アプリケーション用ユーザーの作成**

   ```sql
   CREATE USER 'simpleblog_user'@'%' IDENTIFIED BY 'User!1234';
   GRANT SELECT, INSERT, UPDATE, DELETE ON simpleblog.* TO 'simpleblog_user'@'%';
   FLUSH PRIVILEGES;
   ```

6. **MySQL からログアウト**
   ```sql
   exit
   ```

---

## 9. Web サーバーでの設定

### 手順

1. **DB サーバーから Web サーバーに戻る**

   ```bash
   exit  # DBサーバーから出る
   ```

2. **Web サーバーで MySQL クライアントをインストール**

   ```bash
   sudo dnf install -y mysql php-mysqlnd
   ```

3. **データベース接続テスト**

   ```bash
   mysql -h 10.0.101.20 -u simpleblog_user -p
   ```

   パスワード: User!1234

4. **接続確認後、ログアウト**

   ```sql
   exit
   ```

5. **アプリケーションファイルの更新**

   ```bash
   cd ~
   sudo cp udemy-aws-14days/D04/index.php /var/www/html/
   ```

6. **アプリケーションファイルの内容確認**
   データベース接続の PHP コードが含まれていることを確認してください。パスワードが異なる場合は適宜修正してください。

---

## 10. シンプルブログの動作確認

### 手順

1. **Web サーバーのパブリック IP アドレスを確認**

   - EC2 ダッシュボードで web-1a インスタンスを選択
   - パブリック IP アドレスをコピー

2. **ブラウザでアクセス**
   - `http://[WebサーバーのパブリックIP]`にアクセス
   - 記事のタイトルに「DB」が付いていることを確認
   - これによりデータベースからデータが取得されていることが分かります

---

## 11. リソースの整理と削除

### Day5 以降で不要になるリソースの削除

1. **NAT Gateway の削除**

   - VPC → NAT Gateway
   - 作成した NAT Gateway を選択
   - アクション → NAT Gateway を削除
   - 「削除」と入力して確認

2. **Elastic IP の開放**

   - VPC → Elastic IP
   - NAT Gateway に割り当てられていた EIP を選択
   - アクション → Elastic IP アドレスを開放

3. **ルートテーブルの修正**

   - VPC → ルートテーブル
   - プライベートサブネット用ルートテーブルを選択
   - ルート → ルートを編集
   - 0.0.0.0/0 のルートを削除
   - 変更を保存

4. **動作確認**
   - DB サーバーに接続
   - 外部への接続ができないことを確認
   ```bash
   curl http://[WebサーバーのパブリックIP]
   ```
   ※ レスポンスが返ってこないことを確認（Ctrl+C で中断）

---

## ネットワーク設計のポイント

### 1. VPC とサブネットの適切なサイズ設計

**将来を意識した設計の重要性**

- 小さすぎる設計（/28 など）は実用的でない（約 10 個の IP アドレスのみ）
- ビジネスニーズに応じたリソースの増減に対応できる余裕が必要
- VPC のサイズ変更は基本的に最終手段

**適切なバランス**

- 大きすぎる設計（/16 で 6 万個超の IP アドレス）も問題
- VPC ピアリング時の IP アドレス重複を避ける必要がある
- 各 AWS サービスが必要とする IP アドレス数を把握（例：ELB は各サブネットに 8 個の空き IP が必要）

### 2. 環境分離のベストプラクティス

**推奨：アカウント単位での環境分離**

- 本番、ステージング、開発環境を別々の AWS アカウントで管理
- セキュリティと運用安定性の向上
- 環境間での意図しないリソース共有を防止

**非推奨：VPC 単位での環境分離**

- 同一アカウント内での複数 VPC による環境分離は推奨しない
- 権限管理の複雑化
- 開発生産性の低下リスク

---

## まとめ

Day4 では以下の内容を学習しました：

1. **プライベートサブネットの構築**

   - インターネットから直接アクセスできないサブネットの作成
   - データベースなどの機密性の高いリソース配置に適用

2. **セキュリティグループの高度な設定**

   - セキュリティグループ間の参照による細かいアクセス制御
   - 特定のセキュリティグループからの通信のみを許可

3. **NAT Gateway の活用**

   - プライベートサブネットから外部インターネットへの一方向通信
   - セキュリティを保ちながら必要なパッケージ更新を実現

4. **データベースサーバーの構築**

   - EC2 インスタンス上での MySQL 構築
   - データベースとアプリケーションの分離

5. **踏み台サーバーの概念**
   - プライベートリソースへの安全なアクセス方法
   - Session Manager などの代替手段も存在

### 現在の構成

- VPC 内にパブリック/プライベートサブネットが配置された 2 層構成
- Web サーバー（パブリック）と DB サーバー（プライベート）の分離
- セキュリティグループによる適切なアクセス制御

### プラスアルファチャレンジ

1. **構成図の作成**

   - 今回構築した環境をホワイトボードに手書きで作成
   - 各コンポーネントの役割と関係性を整理

2. **VPC など機能の試用**
   - AWS が提供する VPC 作成ウィザードを使用
   - 今回手動で作成したリソースとの比較
   - ※既存の VPC を削除しないよう注意

Day5 では、この構成をさらに発展させ、より実用的なアーキテクチャを構築していきます。

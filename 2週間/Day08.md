# Day8：ドメインネームシステム(DNS)サービス Amazon Route 53 を使う

## 概要

Amazon Route 53 を使用して DNS サービスの基本を学び、ドメイン名でシンプルブログにアクセスできるように設定します。また、フェイルオーバールーティング機能を使用して障害時の対応も実装します。

## 注意事項

- ドメイン取得時に費用が発生します（14-15 ドル程度）
- ドメイン取得は必須ではありません（デモ視聴のみでも可）
- 一年分の料金を一括で支払う必要があります

## 学習内容

### 1. DNS 基本の理解

#### DNS とは

- **Domain Name System**の略
- ドメイン名と IP アドレスを対応づけ、管理するシステム
- ドメイン名を投げると IP アドレスを返してくれる仕組み

#### 名前解決のプロセス

1. ユーザーがブラウザでドメイン名にアクセス
2. DNS がレコードセットからドメイン名を検索
3. 対応する IP アドレスを返却
4. ユーザーが該当 IP アドレスに接続

#### 主要なレコードタイプ

**A レコード**

- ドメインと IP アドレスを対応させるレコード
- Route 53 では Alias という機能で ALB や CloudFront の DNS 名も指定可能

**NS レコード**

- ドメイン名の解決に必要なネームサーバー情報を指定するレコード
- Route 53 でドメイン取得時に自動作成

**SOA レコード**

- ドメインの責任者など、ドメインの管理情報を格納するレコード
- Route 53 でドメイン取得時に自動作成

**CNAME レコード**

- ドメインの別名をマッピングするレコード
- SSL/TLS 証明書作成時のドメイン所有証明に使用

### 2. Amazon Route 53 の基本

#### 特徴

- ドメインネームシステムのマネージドサービス
- GUI からボタン操作で DNS が使用可能
- CLI、CloudFormation でプログラマブルに操作可能
- SLA 100%定義

#### ルーティングポリシー

**シンプルルーティングポリシー**

- 通常の名前解決
- レコードセットで指定されたリソースにルーティング

**フェイルオーバールーティング**

- 通常時はプライマリー側に振り分け
- 障害時はセカンダリー側に自動的にルーティング

## 実習手順

### 前提条件の確認

1. **EC2 インスタンスの確認**

   - EC2 > インスタンス一覧で Web-1A が起動していることを確認

2. **RDS の確認**

   - RDS > データベースインスタンスが利用可能な状態であることを確認

3. **ALB の確認**
   - EC2 > ロードバランサー > ALB の DNS 名をコピー
   - ブラウザでアクセスしてシンプルブログが表示されることを確認

### Step 1: ドメインの取得

1. **Route 53 コンソールへアクセス**

   ```
   AWSマネジメントコンソール > サービス検索 > Route 53
   ```

2. **ドメイン登録**

   - 「ドメインを登録」をクリック
   - 取得したいドメイン名を入力（例：udemy-aws-14days.net）
   - 検索ボタンをクリック

3. **ドメイン選択**

   - 完全一致のドメインまたは利用可能なドメインを選択
   - 「アクション」>「選択」をクリック
   - 「チェックアウトに進む」をクリック

4. **登録設定**

   - 期間：1 年を選択
   - 自動更新：用途に応じて設定（ハンズオン用なら無効推奨）
   - 「次へ」をクリック

5. **連絡先情報入力**

   - 必要な連絡先情報を入力
   - 「次へ」をクリック

6. **確認・送信**

   - 利用規約を確認しチェック
   - 「送信」をクリック

7. **ステータス確認**

   - 「ステータスを確認」をクリック
   - ステータスが「成功」になるまで待機（15-20 分程度）

8. **メール確認**

   - 登録成功のメールを確認（迷惑メールフォルダもチェック）
   - ベリファイメールが届いた場合は指示に従って認証

9. **ホストゾーンの確認**
   - 「ホストゾーン」をクリック
   - 自動的に NS レコードと SOA レコードが作成されていることを確認

### Step 2: A レコードの作成（シンプルルーティング）

1. **ホストゾーンへアクセス**

   - Route 53 > ホストゾーン > 取得したドメインをクリック

2. **レコード作成**

   - 「レコードを作成」をクリック

3. **A レコード設定**

   - レコード名：`simple-blog`（サブドメイン）
   - レコードタイプ：A
   - Alias：有効にする
   - エンドポイント：「Application Load Balancer と Classic Load Balancer の alias」を選択
   - リージョン：東京リージョンを選択
   - ALB：`udemy-aws-14days-alb`を選択

4. **レコード作成実行**

   - 「レコードを作成」をクリック
   - ステータス表示で INSYNC になるまで待機

5. **動作確認**
   - レコード名をコピー（例：simple-blog.udemy-aws-14days.net）
   - 新しいタブでアクセス
   - シンプルブログが表示されることを確認

### Step 3: フェイルオーバールーティングの設定

#### 前提：S3 バケット（Sorry Page）の確認

- S3 で静的ウェブサイトホスティング用のバケットが存在することを確認
- バケット名：`simple-blog.ドメイン名`形式
- Sorry Page が表示されることを確認

#### プライマリー側の設定

1. **既存 A レコードの編集**

   - 作成した A レコードにチェック
   - 「レコードを編集」をクリック

2. **フェイルオーバー設定**
   - ルーティングポリシー：フェイルオーバー
   - タイプ：プライマリー
   - レコード ID：`udemy-aws-14days-alb`
   - 「保存」をクリック

#### セカンダリー側の設定

1. **新規 A レコード作成**

   - 「レコードを作成」をクリック

2. **セカンダリー設定**

   - レコード名：`simple-blog`（同じサブドメイン）
   - レコードタイプ：A
   - Alias：有効
   - エンドポイント：「S3 ウェブサイトエンドポイントへの alias」を選択
   - リージョン：東京リージョン
   - S3 バケット：該当バケットを選択

3. **フェイルオーバー設定**

   - ルーティングポリシー：フェイルオーバー
   - タイプ：セカンダリー
   - ターゲットのヘルス評価：いいえ
   - レコード ID：`udemy-aws-14days-s3`

4. **レコード作成**
   - 「レコードを作成」をクリック
   - ステータスが INSYNC になるまで待機

### Step 4: フェイルオーバーのテスト

#### 障害の発生

1. **CloudShell へのアクセス**

   - CloudShell を起動

2. **EC2 インスタンスへの SSH 接続**

   ```bash
   ssh -i udemy-aws-14days.pem ec2-user@<パブリックIP>
   ```

3. **Apache の停止**

   ```bash
   sudo systemctl stop httpd
   ```

4. **エラー確認**

   - ブラウザでドメインにアクセス
   - 502 エラーが表示されることを確認

5. **フェイルオーバー確認**
   - 2-10 分程度待機
   - リロードして Sorry Page が表示されることを確認

#### 復旧テスト

1. **Apache の再起動**

   ```bash
   sudo systemctl start httpd
   ```

2. **フェイルバック確認**
   - 1-2 分程度待機
   - リロードしてシンプルブログが表示されることを確認

### Step 5: リソースのクリーンアップ

#### フェイルオーバー設定の削除

1. **セカンダリーレコードの削除**

   - ホストゾーン画面でセカンダリー（S3 alias）の A レコードを選択
   - 「レコードを削除」をクリック
   - 確認して削除

2. **プライマリーレコードの変更**
   - 残った A レコードを選択
   - 「レコードを編集」をクリック
   - ルーティングポリシー：シンプルルーティングに変更
   - 「保存」をクリック

#### S3 バケットの削除

1. **バケットの空化**

   - S3 コンソールで該当バケットを選択
   - 「バケットを空にする」をクリック
   - 「完全に削除」をクリック

2. **バケットの削除**

   - 「バケットを削除」をクリック
   - バケット名を入力して削除実行

3. **動作確認**
   - ドメインでシンプルブログが正常に表示されることを確認

## まとめ

### 学習内容の振り返り

- DNS の基本概念と Amazon Route 53 の機能を理解
- ドメイン取得から DNS レコード設定までの一連の流れを体験
- シンプルルーティングとフェイルオーバールーティングを実装
- 障害時の自動切り替え機能を確認

### プラスアルファチャレンジ

1. **他のルーティングポリシーの調査**

   - 重み付きルーティング
   - レイテンシールーティング
   - 地理的ルーティング
   - 複数値回答ルーティング

2. **外部レジストラでのドメイン活用**
   - 他のレジストラで取得したドメインを Route 53 で使用する方法
   - ネームサーバーの変更手順

## 重要なポイント

### フェイルオーバーの特徴

- 切り替わりまでに時間がかかる場合がある（2-10 分程度）
- TTL やキャッシュの影響を受ける
- 即座の切り替えが必要な場合は別の手法を検討

### コスト管理

- ドメインは一年分の料金が一括請求
- 自動更新設定に注意
- 使用しないドメインは適切な時期に削除

### セキュリティ

- ドメイン認証メールは確実に処理
- 迷惑メールフォルダもチェック
- ドメインの所有権を適切に管理

## 次のステップ

Route 53 の基本的な使い方を理解したので、次は他の AWS サービスとの連携やより高度な DNS 設定について学習していきます。

Day6 のハンズオンに関する情報を掲載します。

# Day6-2

## 1. Cognito ユーザープールの作成

### 1.1 Cognito サービスへの移動

1. AWS マネジメントコンソール左上の検索窓に「cognito」と入力
2. ハンバーガーメニュー(左上)を押す
3. 「ユーザープール」をクリック

### 1.2 ユーザープールの作成

1. 右上の「ユーザープールを作成」ボタンをクリック

#### アプリケーションの定義

- **アプリケーションタイプ**: シングルページアプリケーション(SPA)を選択
- **アプリケーション名**: `Simple Weather News Admin`

#### サインイン設定

- **サインイン識別子のオプション**: メールアドレスを選択
- **サインアップのための必須属性**: プルダウンから「Email」を選択

2. 「ユーザーディレクトリを作成する」をクリック

### 1.3 ユーザープール名の変更

1. トーストメッセージが表示されたら閉じる
2. ページ下部にスクロールして「概要に移動」をクリック
3. 「名前変更」をクリック
4. ユーザープール名を変更: `User pool - Simple Weather News Admin`
5. 「変更を保存」をクリック

## 2. Cognito ユーザープールの設定

### 2.1 パスワードポリシーの設定

1. 左側メニューから「認証」→「認証方法」をクリック
2. 「パスワードポリシー」の「編集」をクリック
3. 「カスタム」を選択
4. 最小文字数: 8 文字以上(その他の要件はすべて外す)
5. 「変更を保存」をクリック

### 2.2 サインアップ設定の確認

1. 左側メニューから「サインアップ」をクリック
2. ページ下部の「セルフサービスのサインアップ」が「有効」になっていることを確認
   - ※ユーザーが自らアカウント登録できる設定

### 2.3 アプリケーションクライアントの設定

1. 左側メニューから「アプリケーション」→「アプリケーションクライアント」をクリック
2. 「Simple Weather News Admin」をクリック
3. 右上の「編集」をクリック
4. ✅「ユーザー名とパスワードを使用してサインインします」にチェックを入れる
5. 「変更を保存」をクリック

### 2.4 重要情報のコピー

#### クライアント ID のコピー

- アプリケーションクライアント画面で「クライアント ID」をコピーしてエディタに保存

#### ユーザープール ID のコピー

1. 左側メニューの「概要」をクリック
2. 「ユーザープール ID」をコピーしてエディタに保存

## 3. API Gateway のオーソライザー設定

### 3.1 API Gateway への移動

1. AWS マネジメントコンソールロゴを右クリック → 新しいタブで開く
2. 検索窓に「API Gateway」と入力して移動
3. 「simple-weather-news-api」をクリック

### 3.2 オーソライザーの作成

1. 左側メニューから「Authorization」をクリック
2. 「オーソライザーを管理」タブをクリック
3. 「作成」をクリック

#### オーソライザーの設定

- **オーソライザータイプ**: JWT(JSON Web Token)のまま
- **オーソライザー名**: `simple-weather-news-authorizer`
- **ID ソース**: そのまま
- **発行者 URL**:

  ```
  https://cognito-idp.ap-northeast-1.amazonaws.com/<USER_POOL_ID>
  ```

  ※`<USER_POOL_ID>`の部分を、先ほどコピーしたユーザープール ID(ap-northeast から始まる ID)に置き換える

- **対象者**: 「対象者を追加」をクリックし、先ほどコピーした**クライアント ID**を貼り付ける

4. 「作成」をクリック

### 3.3 オーソライザーのアタッチ

1. 「オーソライザーをルートにアタッチ」タブに戻る

#### /all の GET メソッドにアタッチ

1. 左側から「/all」→「GET」をクリック
2. 「既存のオーソライザーを選択」プルダウンから「simple-weather-news-authorizer」を選択
3. 「オーソライザーをアタッチ」をクリック

#### /{id} の GET メソッドにアタッチ

1. 左側から「/{id}」→「GET」をクリック
2. 「既存のオーソライザーを選択」プルダウンから「simple-weather-news-authorizer」を選択
3. 「オーソライザーをアタッチ」をクリック

#### /{id} の PUT メソッドにアタッチ

1. 左側から「/{id}」→「PUT」をクリック
2. 「既存のオーソライザーを選択」プルダウンから「simple-weather-news-authorizer」を選択
3. 「オーソライザーをアタッチ」をクリック

### 3.4 認証の動作確認

1. 画面上部の「API: simple-weather...」をクリック
2. 「デフォルトのエンドポイント」をクリック

#### /all エンドポイントの確認

- ブラウザで `/all` にアクセス
- **結果**: `Unauthorized` エラーが表示される(認証が必要になった証拠)

#### /{id} エンドポイントの確認

- URL を `/13` に変更してアクセス
- **結果**: 最初は `Unauthorized` エラーが表示される(こちらも認証が必要になった)

## 4. フロントエンド側の動作確認

### 4.1 S3 ホスティングの確認

1. AWS マネジメントコンソールロゴを右クリック → 新しいタブで開く
2. 「S3」サービスに移動
3. 「simple-weather-news-admin」バケットをクリック
4. 「プロパティ」タブから「静的ウェブサイトホスティング」のエンドポイントをクリック

### 4.2 認証なしでのアクセス確認

- メールアドレス形式とパスワード(1 文字以上)を入力してサインイン
- **結果**: 全国の天気予報一覧画面でデータが表示されない(401 エラー)

### 4.3 開発者ツールでのエラー確認

1. ブラウザの開発者ツール(F12)を開く
2. コンソールタブで「401」エラーを確認
   - `/all` への GET リクエストが認証エラーになっていることを確認

## まとめ

この段階で以下が完了しました:

- ✅ Cognito ユーザープールの作成と設定
- ✅ API Gateway への JWT 認証(オーソライザー)の設定
- ✅ 全エンドポイント(/all の GET、/{id} の GET/PUT)への認証の適用
- ✅ 認証なしでは API にアクセスできないことの確認

**次のステップ**:

- フロントエンドにサインアップ/サインイン機能を実装
- 認証済みユーザーが API を呼び出せるように修正

# Day6-3

参考:Day6-3 の最終断面については、Day06/simple_weather_admin/Day06-03-end 以下に格納してあります

## 1. サインアップ機能の実装概要

この動画では、フロントエンドに Cognito と連携したサインアップ機能を追加します。

### 実装内容

- フロントエンド側のサインアップ機能は既に Vue.js で実装済み
- Cognito ユーザープール関連の情報を設定ファイルに埋め込む
- サインアップ機能を動作可能にする

**注意**: この段階ではサインアップのみ実装し、サインイン機能は次の動画で実装します

## 2. サインアップ機能の動作確認(修正前)

### 2.1 フロントエンドへのアクセス

1. S3 バケット「simple-weather-news-admin」の静的ウェブサイトホスティング URL にアクセス
2. 「サインアップ」タブをクリック

### 2.2 サインアップの試行

1. メールアドレス欄に任意のメールアドレスを入力(この時点では何でも OK)
2. パスワード欄に 8 文字以上のパスワードを入力(例: `12345678`)
3. パスワード(確認)欄に同じパスワードを入力
4. 「サインアップ」ボタンをクリック

**結果**: 「ユーザープールのクライアント ID が設定されていません」というエラーメッセージが表示される

### フロントエンド側のバリデーション

- パスワードが一致しない場合 → 「パスワードが一致しません」エラー
- パスワードが 8 文字未満の場合 → フロントエンドのバリデーションで弾かれる
- その他の場合 → 「ユーザープールのクライアント ID が設定されていません」エラー

## 3. Vue.js コードの確認

### 3.1 CloudShell の起動

1. AWS マネジメントコンソール右上の CloudShell アイコンをクリック
2. ホームディレクトリから作業ディレクトリに移動:

```bash
cd ~/work-simple-weather-news-admin
```

### 3.2 index.html のコード確認

```bash
vim index.html
```

#### サインアップメソッドの確認

- **ファイル**: `index.html`
- **場所**: JavaScript の後半部分
- **メソッド名**: `signUp()`

**処理内容**:

1. パスワード一致のバリデーション(フロントエンド側)
2. `authService.signUp()` メソッドを呼び出し

### 3.3 JavaScript(js/auth.js)のコード確認

```bash
vim js/auth.js
```

#### Auth サービスの確認

**ファイル上部の処理**:

1. **コンストラクタ**: 画面立ち上げ時に `initializeUserPool()` を実行
2. **initializeUserPool()**: ユーザープール ID とクライアント ID を使ってユーザープールインスタンスを作成
3. **signUp()**: ユーザープール側が用意している `signUp()` メソッドを呼び出し

**設定ファイルの参照**:

- ユーザープール ID: `config.js` の `userPoolId` を参照
- クライアント ID: `config.js` の `clientId` を参照

## 4. 設定ファイルの修正

### 4.1 config.js の編集

```bash
vim js/config.js
```

#### 現在の設定内容

```javascript
userPoolId: 'dummy-user-pool-id',
clientId: 'dummy-client-id',
```

これらのダミー値を、Day6-2 でコピーした実際の値に置き換えます。

### 4.2 ユーザープール ID の設定

1. `i` キーでインサートモードに切り替え
2. `userPoolId` の値(`'dummy-user-pool-id'`)を削除
3. コピーしておいた**ユーザープール ID**を貼り付け(Ctrl + V)

**注意**: ユーザープール ID は `ap-northeast-1_xxxxxxxxx` の形式です

### 4.3 クライアント ID の設定

1. `clientId` の値(`'dummy-client-id'`)を削除
2. コピーしておいた**クライアント ID**を貼り付け(Ctrl + V)

**注意**: ユーザープール ID とクライアント ID を逆に入れないように注意してください

### 4.4 保存

1. `Esc` キーで編集モードを終了
2. `:wq` と入力して保存

## 5. S3 へのファイル同期

### 5.1 S3 バケット名の確認

1. AWS マネジメントコンソールで S3 サービスに移動
2. 「simple-weather-news-admin」バケット名全体をコピー

### 5.2 aws s3 sync コマンドの実行

```bash
aws s3 sync . s3://simple-weather-news-admin-<YOUR-ACCOUNT-ID>/
```

**パラメータ説明**:

- `.`: カレントディレクトリ(~/work-simple-weather-news-admin)
- `s3://バケット名/`: アップロード先の S3 バケット

**結果**: `js/config.js` のみがアップロードされたことが表示される

## 6. サインアップ機能の動作確認(修正後)

### 6.1 ページの再読み込み

1. 静的ウェブサイトホスティング URL にアクセス
2. スーパーリロード(Ctrl + Shift + R または Ctrl + F5)でキャッシュをクリア

### 6.2 サインアップの実行

1. 「サインアップ」タブをクリック
2. **メールアドレス**: 受信可能な実際のメールアドレスを入力
3. **パスワード**: 8 文字以上のパスワードを入力
4. **パスワード(確認)**: 同じパスワードを入力
5. 「サインアップ」ボタンをクリック

**結果**: 「メールに送信された確認コードを入力してください」というメッセージと入力欄が表示される

### 6.3 確認コードの入力

1. 登録したメールアドレス宛に Cognito から確認コードが届く
2. メールに記載された 6 桁の確認コード(例: `816467`)を入力
3. 「確認」ボタンをクリック

**結果**: 「アカウントが確認されました。サインインしてください。」というメッセージが表示される

## 7. Cognito ユーザープールでの確認

### 7.1 ユーザー一覧の確認

1. AWS マネジメントコンソールで Cognito サービスに移動
2. 「simple-weather-news-admin」ユーザープールをクリック
3. 左側メニューから「ユーザー」をクリック

**結果**: 登録したメールアドレスのユーザーが一覧に表示される

### 7.2 ユーザー詳細の確認

- **ユーザー名**: 登録したメールアドレス
- **ステータス**: 確認済み(CONFIRMED)
- **メール検証済み**: true

## 8. サインイン機能の状態

### 8.1 現在の状態

- サインアップ機能: ✅ 実装完了
- サインイン機能: ❌ まだ実装されていない

### 8.2 サインイン画面の動作

現時点では、サインイン画面で以下のような動作になります:

1. 任意のメールアドレスとパスワードを入力
2. 「サインイン」ボタンをクリック
3. 画面遷移は行われる(ダミー実装)
4. しかし、実際には Cognito と連携していない

**注意**: サインイン機能の実装は次の動画(Day6-4)で行います

## CloudShell 上での作業コマンド

```bash
cd ~/work-simple-weather-news-admin
vim js/config.js
aws s3 sync . s3://your-bucket-name/
```

## まとめ

この段階で以下が完了しました:

- ✅ Vue.js で実装されたサインアップ機能のコード確認
- ✅ config.js にユーザープール ID とクライアント ID を設定
- ✅ Cognito と連携したサインアップ機能の動作確認
- ✅ メール確認コードによるアカウント確認
- ✅ Cognito ユーザープールでのユーザー登録確認

**次のステップ**:

- サインイン機能の実装(Day6-4)
- 認証トークンを使った API 呼び出しの実装

# Day6-4

参考：Day6-4 の最終断面については、Day06/simple_weather_admin/Day06-04-end 以下に格納してあります

## CloudShell 上での作業コマンド

```bash
cd ~/work-simple-weather-news-admin
vim index.html
aws s3 sync . s3://your-bucket-name/
```

# Day6-5

参考：Day6-5 の最終断面については、Day06/simple_weather_admin/Day06-05-end 以下に格納してあります

## CloudShell 上での作業コマンド

```bash
cd ~/work-simple-weather-news-admin
vim list.html
aws s3 sync . s3://your-bucket-name/
```

# Day6-6

参考：Day6-6 の最終断面については、Day06/simple_weather_admin/Day06-06-end 以下に格納してあります

## CloudShell 上での作業コマンド

```bash
cd ~/work-simple-weather-news-admin
vim detail.html
aws s3 sync . s3://your-bucket-name/
```

# Day6-7

参考：Day6-7 の最終断面については、Day06/simple_weather_admin/Day06-07-end 以下に格納してあります

## CloudShell 上での作業コマンド

```bash
cd ~/work-simple-weather-news-admin
vim detail.html
aws s3 sync . s3://your-bucket-name/
```
